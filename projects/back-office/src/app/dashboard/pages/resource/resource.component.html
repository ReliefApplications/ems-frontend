<mat-spinner diameter="45" class="page-loader" *ngIf="loading"></mat-spinner>
<ng-container *ngIf="!loading && resource">
    <div class="page-header">
        <safe-previous-button path="/resources"></safe-previous-button>
        <h1 class="page-title">
            {{resource.name}}
        </h1>
        <safe-access [access]="resource.permissions" (save)="saveAccess($event)" *ngIf="resource.canUpdate">
        </safe-access>
        <div class="actions">
            <safe-button *ngIf="resource.canUpdate && !showDeletedRecords" icon="search_off" category="primary"
                variant="danger" (click)="onSwitchView($event)">
                {{'record.archived' | translate}}
            </safe-button>
            <safe-button *ngIf="resource.canUpdate && showDeletedRecords" icon="restore_page" category="primary"
                variant="success" (click)="onSwitchView($event)">
                {{'record.active' | translate}}
            </safe-button>
            <safe-button icon="file_download" category="secondary" variant="primary" [matMenuTriggerFor]="menu">
                {{'record.download' | translate}}
            </safe-button>
            <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="onDownload('csv')">.csv</button>
                <button mat-menu-item (click)="onDownload('xlsx')">.xlsx</button>
            </mat-menu>
            <safe-button icon="file_upload" category="secondary" variant="primary"
             matTooltip="File should contain one record per row. Header row contains the names of data fields."
             [matMenuTriggerFor]="matUploadMenu">
             {{'record.upload' | translate}}
            </safe-button>
            <mat-menu #matUploadMenu="matMenu">
                <button mat-menu-item (click)="onDownloadTemplate()">{{'users.getTemplate' | translate}}</button>
                <input #xlsxFile type="file" data-max-size="5120" accept=".xlsx" (change)="onFileChange($event)" />
            </mat-menu>
        </div>
    </div>
    <mat-tab-group dynamicHeight>
        <mat-tab>
            <ng-template mat-tab-label>
                {{'table.records' | translate}} ( {{pageInfo.length}} )
            </ng-template>
            <div class="table-container">
                <table mat-table [dataSource]="dataSourceRecords">
                    <ng-container *ngFor="let column of displayedColumnsRecords" [matColumnDef]="column"
                        [stickyEnd]="column === '_actions'">
                        <ng-container *ngIf="!recordsDefaultColumns.includes(column)">
                            <th mat-header-cell *matHeaderCellDef>{{column}}</th>
                            <td mat-cell *matCellDef="let element" class="table-column">
                                <div>{{element.data[column]}}</div>
                            </td>
                        </ng-container>
                        <ng-container *ngIf="column === '_incrementalId'">
                            <th mat-header-cell *matHeaderCellDef class="table-column">ID</th>
                            <td mat-cell *matCellDef="let element" class="table-column">
                                <div>{{element.incrementalId}}</div>
                            </td>
                        </ng-container>
                        <ng-container *ngIf="column === '_actions'">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let element">
                                <safe-button [isIcon]="true" icon="more_vert" [matMenuTriggerFor]="recMenu"
                                    (click)="$event.stopPropagation()">
                                </safe-button>
                                <mat-menu #recMenu="matMenu">
                                    <button mat-menu-item [routerLink]="['./update', element.id]"
                                        [matTooltip]="'Edit as ' + element.form.name" matTooltipPosition="above"
                                        [matTooltipDisabled]="resource.forms.length <= 1">
                                        <mat-icon>edit</mat-icon>
                                        {{'action.edit' | translate}}
                                    </button>
                                    <button *ngIf="resource.forms.length > 1" mat-menu-item
                                        [matMenuTriggerFor]="templates">
                                        <mat-icon>edit_note</mat-icon>
                                        {{'actionAs.edit' | translate}}
                                    </button>
                                    <button *ngIf="!showDeletedRecords" mat-menu-item
                                        (click)="onDeleteRecord(element, $event)">
                                        <mat-icon>delete</mat-icon>
                                        {{'action.delete' | translate}}
                                    </button>
                                    <button *ngIf="showDeletedRecords" mat-menu-item
                                        (click)="onDeleteRecord(element, $event)">
                                        <mat-icon>delete_forever</mat-icon>
                                        {{'action.deletePerm' | translate}}
                                    </button>
                                    <button *ngIf="showDeletedRecords" mat-menu-item
                                        (click)="onRestoreRecord(element.id, $event)">
                                        <mat-icon>unarchive</mat-icon>
                                        {{'action.restore' | translate}}
                                    </button>
                                </mat-menu>
                                <mat-menu #templates="matMenu">
                                    <ng-container *ngFor="let form of filterTemplates(element)">
                                        <button mat-menu-item [routerLink]="['./update', element.id]"
                                            [state]="{ template: form.id }">{{form.name}}</button>
                                    </ng-container>
                                </mat-menu>
                            </td>
                        </ng-container>
                    </ng-container>
                    <tr mat-header-row *matHeaderRowDef="displayedColumnsRecords"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumnsRecords;"></tr>
                </table>
            </div>
            <mat-paginator [pageSize]="pageInfo.pageSize" [length]="pageInfo.length" aria-label="Select page of records"
                (page)="onPage($event)"></mat-paginator>
        </mat-tab>
        <mat-tab>
            <ng-template mat-tab-label>
                {{'sidenav.forms' | translate}} ( {{resource.forms.length}} )
            </ng-template>
            <ng-container *ngIf="!loading">
                <table mat-table [dataSource]="dataSourceForms">
                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef> {{'global.name' | translate}} </th>
                        <td mat-cell *matCellDef="let element"> {{element.name}} </td>
                    </ng-container>

                    <ng-container matColumnDef="createdAt">
                        <th mat-header-cell *matHeaderCellDef> {{'table.date' | translate}} </th>
                        <td mat-cell *matCellDef="let element"> {{element.createdAt | date}} </td>
                    </ng-container>

                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef> {{'global.status' | translate}} </th>
                        <td mat-cell *matCellDef="let element">
                            <mat-chip-list>
                                <mat-chip class="success-chip" disabled *ngIf="element.status === 'active'">
                                    {{ 'status.active' | translate | titlecase }}
                                </mat-chip>
                                <mat-chip class="accent-chip" disabled color="accent"
                                    *ngIf="element.status === 'pending'">
                                    {{ 'status.pending' | translate | titlecase }}
                                </mat-chip>
                                <mat-chip class="warn-chip" disabled color="warn" *ngIf="element.status === 'archived'">
                                    {{ 'status.archived' | translate | titlecase }}
                                </mat-chip>
                            </mat-chip-list>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="recordsCount">
                        <th mat-header-cell *matHeaderCellDef> {{'table.records' | translate}} </th>
                        <td mat-cell *matCellDef="let element"> {{element.recordsCount}} </td>
                    </ng-container>

                    <ng-container matColumnDef="core">
                        <th mat-header-cell *matHeaderCellDef> {{'table.core' | translate}} </th>
                        <td mat-cell *matCellDef="let element">
                            <mat-chip-list *ngIf="element.core">
                                <mat-chip class="primary-chip" disabled>{{'global.core' | translate}}</mat-chip>
                            </mat-chip-list>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="_actions">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let element">
                            <safe-button [isIcon]="true" icon="more_vert" [matMenuTriggerFor]="resMenu"
                                (click)="$event.stopPropagation()"
                                [disabled]="!(element.canUpdate || element.canDelete )">
                            </safe-button>
                            <mat-menu #resMenu="matMenu">
                                <button mat-menu-item [routerLink]="['/forms/builder', element.id]"
                                    *ngIf="element.canUpdate">
                                    <mat-icon>edit</mat-icon>
                                    {{'action.edit' | translate}}
                                </button>
                                <button mat-menu-item (click)="deleteForm(element.id, $event)"
                                    *ngIf="element.canDelete">
                                    <mat-icon>delete</mat-icon>
                                    {{'action.delete' | translate}}
                                </button>
                            </mat-menu>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumnsForms"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumnsForms;"
                        [ngClass]="{'clickable': ( row.canCreateRecords && (row.status === 'active') )}"
                        [routerLink]="( row.canCreateRecords && (row.status === 'active') ) ? ['/forms/answer', row.id] : []">
                    </tr>
                </table>
            </ng-container>
        </mat-tab>
    </mat-tab-group>
</ng-container>