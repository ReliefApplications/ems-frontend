<ng-container *ngIf="form">
  <form [formGroup]="form" [ngClass]="{ 'field-form': isField }">
    <div>
      <mat-form-field appearance="outline" *ngIf="!isField && canSelectDataSet">
        <mat-label>{{
          'components.queryBuilder.dataset.select' | translate
        }}</mat-label>
        <input
          type="text"
          [placeholder]="'components.queryBuilder.dataset.select' | translate"
          matInput
          formControlName="name"
          [matAutocomplete]="auto"
        />
        <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete">
          <mat-option *ngFor="let option of filteredQueries" [value]="option">
            {{ option }}
          </mat-option>
        </mat-autocomplete>
        <safe-icon
          *ngIf="canSelectDataSet && form.invalid"
          matSuffix
          icon="error"
          variant="danger"
          [matTooltip]="'components.form.layout.errors.invalid' | translate"
        ></safe-icon>
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        *ngIf="!isField && canSelectDataSet && templates.length > 0"
      >
        <mat-label>{{ 'models.form.template' | translate }}</mat-label>
        <mat-select formControlName="template">
          <mat-option>-</mat-option>
          <mat-option
            *ngFor="let template of templates"
            [value]="template.id"
            >{{ template.name }}</mat-option
          >
        </mat-select>
      </mat-form-field>
    </div>

    <ng-container *ngIf="isField">
      <div>
        <safe-button [isIcon]="true" icon="arrow_back" (click)="onCloseField()">
        </safe-button>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'models.form.field.name' | translate }}</mat-label>
          <input matInput formControlName="name" type="text" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'models.form.field.label' | translate }}</mat-label>
          <input matInput formControlName="label" type="text" />
        </mat-form-field>
      </div>
    </ng-container>
    <mat-tab-group
      mat-align-tabs="start"
      animationDuration="0ms"
      *ngIf="form.getRawValue().name"
    >
      <mat-tab [label]="'components.queryBuilder.fields.title' | translate">
        <ng-template matTabContent>
          <safe-tab-fields
            *ngIf="availableFields.length > 0"
            [form]="$any(form.controls.fields)"
            [fields]="availableFields"
            [showLimit]="true"
          ></safe-tab-fields>
        </ng-template>
      </mat-tab>
      <mat-tab
        [label]="
          (showLimit && form.get('first') !== null
            ? 'components.queryBuilder.sort.limitTitle'
            : 'components.queryBuilder.sort.title'
          ) | translate
        "
        *ngIf="form.get('sort')"
      >
        <ng-template matTabContent>
          <safe-tab-sort
            [form]="form"
            [fields]="availableScalarFields"
            [showLimit]="showLimit && form.get('first') !== null"
          ></safe-tab-sort>
        </ng-template>
      </mat-tab>
      <mat-tab
        [label]="'components.queryBuilder.filter.title' | translate"
        *ngIf="showFilter && form.get('filter')"
      >
        <ng-template matTabContent>
          <safe-tab-filter
            [form]="$any(form.controls.filter)"
            [query]="form.getRawValue()"
          >
          </safe-tab-filter>
        </ng-template>
      </mat-tab>
      <mat-tab
        [label]="'components.queryBuilder.style.title' | translate"
        *ngIf="showStyle && form.get('style')"
      >
        <ng-template matTabContent>
          <safe-tab-style
            [form]="$any(form.controls.style)"
            [scalarFields]="availableScalarFields"
            [query]="form.getRawValue()"
          >
          </safe-tab-style>
        </ng-template>
      </mat-tab>
      <mat-tab [label]="'common.preview' | translate" *ngIf="layoutPreviewData">
        <ng-template matTabContent>
          <safe-tab-layout-preview [data]="layoutPreviewData">
          </safe-tab-layout-preview>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  </form>
</ng-container>
