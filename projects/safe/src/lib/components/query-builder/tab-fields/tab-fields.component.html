<safe-alert class="mb-4">
  <safe-icon icon="info"></safe-icon>
  {{ 'components.queryBuilder.hint.fields' | translate }}
</safe-alert>
<div
  cdkDropListGroup
  class="flex overflow-auto mb-10"
  [ngClass]="{ hidden: fieldForm }"
>
  <div class="field-container" *ngIf="!fieldForm">
    <h2>{{ 'components.queryBuilder.fields.available' | translate }}</h2>

    <mat-form-field appearance="outline" class="!w-full">
      <mat-label>{{
        'components.queryBuilder.fields.search' | translate
      }}</mat-label>
      <input type="text" matInput [(ngModel)]="searchAvailable" />
      <safe-button
        matSuffix
        (click)="searchAvailable = ''"
        [isIcon]="true"
        [icon]="searchAvailable ? 'cancel' : 'search'"
      ></safe-button>
    </mat-form-field>

    <div class="field-list-wrapper">
      <div
        cdkDropList
        [cdkDropListData]="availableFields"
        class="field-list"
        cdkDropListSortingDisabled
        (cdkDropListDropped)="drop($event)"
      >
        <ng-container *ngFor="let field of availableFields">
          <div
            class="field-box"
            cdkDrag
            *ngIf="
              searchAvailable.length < 1 ||
              field.name.toLowerCase().includes(searchAvailable.toLowerCase())
            "
          >
            {{ field.name }}
            <span class="text-gray-500" *ngIf="field.type.kind !== 'SCALAR'">
              {{ field.type.kind }}
            </span>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <div class="field-container" *ngIf="!fieldForm">
    <h2>{{ 'components.queryBuilder.fields.selected' | translate }}</h2>

    <mat-form-field appearance="outline" class="!w-full">
      <mat-label>{{
        'components.queryBuilder.fields.search' | translate
      }}</mat-label>
      <input type="text" matInput [(ngModel)]="searchSelected" />
      <safe-button
        matSuffix
        (click)="searchSelected = ''"
        [isIcon]="true"
        [icon]="searchSelected ? 'cancel' : 'search'"
      ></safe-button>
    </mat-form-field>

    <div class="field-list-wrapper">
      <div
        cdkDropList
        [cdkDropListData]="selectedFields"
        [cdkDropListSortingDisabled]="searchSelected.length > 0"
        class="field-list"
        (cdkDropListDropped)="drop($event)"
      >
        <ng-container *ngFor="let field of selectedFields; let index = index">
          <div
            class="field-box"
            *ngIf="
              searchSelected.length < 1 ||
              field.name.toLowerCase().includes(searchSelected.toLowerCase())
            "
            cdkDrag
          >
            <div>
              <span>{{ field.name }}</span>
              <safe-button
                [isIcon]="true"
                icon="error"
                class="text-red-600"
                (click)="onEdit(index)"
                *ngIf="form.at(index)?.invalid && field.type"
              >
              </safe-button>
              <safe-button
                [isIcon]="true"
                icon="close"
                class="text-red-600"
                *ngIf="!field.type"
                (click)="onDelete(index)"
                [matTooltip]="
                  'components.queryBuilder.errors.field.invalid' | translate
                "
              >
              </safe-button>
            </div>
            <div *ngIf="field.type">
              <span
                class="text-gray-500"
                *ngIf="field.type.kind !== 'SCALAR'"
                >{{ field.type.kind }}</span
              >
              <safe-button [isIcon]="true" icon="edit" (click)="onEdit(index)">
              </safe-button>
            </div>
          </div>
        </ng-container>
      </div>
      <safe-icon
        *ngIf="searchSelected"
        icon="info"
        class="floating-info cursor-pointer"
        variant="grey"
        [size]="32"
        [matTooltip]="
          'components.queryBuilder.hint.sortingDisabled' | translate
        "
      ></safe-icon>
    </div>
  </div>

  <div class="field-container" *ngIf="fieldForm">
    <ng-container *ngIf="fieldForm.value.kind === 'SCALAR'">
      <form
        [formGroup]="fieldForm"
        class="p-4 rounded-lg border border-gray-300"
      >
        <div class="flex gap-2">
          <safe-button
            [isIcon]="true"
            icon="arrow_back"
            (click)="onCloseField()"
          >
          </safe-button>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'models.form.field.name' | translate }}</mat-label>
            <input
              matInput
              formControlName="name"
              type="text"
              [disabled]="true"
            />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'models.form.field.label' | translate }}</mat-label>
            <input matInput formControlName="label" type="text" />
          </mat-form-field>
        </div>
      </form>
    </ng-container>
    <ng-container
      *ngIf="fieldForm.value.kind !== 'SCALAR'"
      [ngTemplateOutlet]="childTemplate"
    ></ng-container>
  </div>
</div>
<ng-template #childTemplate></ng-template>
