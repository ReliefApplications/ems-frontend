<div class="border-2 border-opacity-20 border-black rounded-md bg-white">
  <!-- Small control ( not showing legend ) -->
  <button class="bg-none p2" (click)="toggleVisibility()" *ngIf="!expanded">
    <safe-icon icon="list"></safe-icon>
  </button>
  <!-- Expanded control ( showing legend ) -->
  <div class="flex flex-col w-48" *ngIf="expanded">
    <!-- Header -->
    <div
      class="flex px-2 py-1 justify-between items-center border-opacity-20 border-b-2"
    >
      <!-- todo(gis): translate -->
      <h2 class="m-0">LEGEND</h2>
      <safe-button
        icon="close"
        [isIcon]="true"
        (click)="toggleVisibility()"
      ></safe-button>
    </div>
    <!-- Layers -->
    <div class="max-h-80 overflow-y-auto p-2 flex flex-col gap-2">
      <div *ngFor="let layerLegend of layerLegends">
        <h3 class="font-black mb-0">{{ layerLegend.layer }}</h3>
        <!-- Features -->
        <div
          *ngIf="layerLegend.legend.type === 'feature'"
          class="flex flex-col gap-1"
        >
          <div
            *ngFor="let item of layerLegend.legend.items"
            class="flex gap-3 items-center"
          >
            <!-- Point -->
            <i
              *ngIf="item.icon && item.icon !== 'leaflet_default'"
              [style.color]="item.color"
              class="{{ item.icon | safeIconDisplay: 'fa' }}"
            ></i>

            <!-- Polygon (or point with no icon provided) -->
            <div
              *ngIf="!item.icon || item.icon === 'leaflet_default'"
              class="w-6 h-6 rounded-sm"
              [ngStyle]="{ 'background-color': item.color }"
            ></div>
            <span>{{ item.label }}</span>
          </div>
        </div>
        <!-- Clusters -->
        <div
          *ngIf="layerLegend.legend.type === 'cluster'"
          class="flex flex-col gap-1"
        >
          <div class="grid grid-cols-2 w-fit gap-2 items-center">
            <!-- todo(gis): sizes should not come from that, but should be calculated from the layer directly -->
            <ng-container
              *ngFor="
                let size of [
                  layerLegend.legend.min,
                  (layerLegend.legend.min + layerLegend.legend.max) / 2,
                  layerLegend.legend.max
                ];
                let i = index
              "
            >
              <div class="w-full h-full flex items-center justify-center">
                <i
                  *ngIf="
                    layerLegend.legend.icon &&
                    layerLegend.legend.icon !== 'leaflet_default'
                  "
                  [style.color]="layerLegend.legend.color"
                  [style.fontSize.px]="size"
                  class="{{ layerLegend.legend.icon | safeIconDisplay: 'fa' }}"
                ></i>
                <!-- <div
                  class="rounded-full"
                  [ngStyle]="{
                    'background-color': layerLegend.legend.color,
                    width: size + 'px',
                    height: size + 'px'
                  }"
                ></div> -->
              </div>

              <span class="ml-2">
                {{ i === 0 ? '≤' : i === 1 ? '' : '≥' }} {{ size }}</span
              >
            </ng-container>
          </div>
        </div>
        <!-- Heatmap -->
        <div *ngIf="layerLegend.legend.type === 'heatmap'" class="flex gap-1">
          <div
            class="heatmap-legend h-52 w-8 bg-slate-600"
            [ngStyle]="{
              background: getCssGradient(layerLegend.legend.gradient)
            }"
          ></div>
          <div class="h-52 relative flex-grow">
            <!-- IN THE LOGIC BELOW, 208 IS THE HEIGHT OF THE GRADIENT DIV, AND 18 THE FONT SIZE -->
            <span
              *ngFor="let color of layerLegend.legend.gradient; let i = index"
              [ngStyle]="{
                left: '10px',
                top:
                  i === 0
                    ? '0'
                    : 208 *
                        (color.value - layerLegend.legend.gradient[0].value) -
                      color.value * 18 +
                      'px'
              }"
              class="absolute"
              >{{ color.label }}</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
