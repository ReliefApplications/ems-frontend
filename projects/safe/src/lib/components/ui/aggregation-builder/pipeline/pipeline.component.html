<mat-accordion>
  <mat-expansion-panel *ngFor="let stageForm of pipelineForm.controls; let index = index ">
    <mat-expansion-panel-header>
      <mat-panel-title>
        {{'aggregation.stages.' + stageForm.value.type | translate}}
      </mat-panel-title>
    </mat-expansion-panel-header>
    <ng-container [ngSwitch]="stageForm.value.type">
      <ng-container *ngSwitchCase="stageType.FILTER">
        <safe-tab-filter [form]="$any(stageForm).controls.form" [fields]="fieldsPerStage[index]" [metaFields]="metaFields">
        </safe-tab-filter>
      </ng-container>
      <ng-container *ngSwitchCase="stageType.SORT">
        <safe-tab-sort [form]="$any(stageForm).controls.form" [fields]="fieldsPerStage[index]"></safe-tab-sort>
      </ng-container>
      <ng-container *ngSwitchCase="stageType.GROUP">
        <safe-group-stage [form]="$any(stageForm).controls.form" [fields]="fieldsPerStage[index]"></safe-group-stage>
      </ng-container>
      <ng-container *ngSwitchCase="stageType.ADD_FIELDS">
        <safe-add-field-stage [form]="$any(stageForm).controls.form" [fields]="fieldsPerStage[index]"></safe-add-field-stage>
      </ng-container>
      <ng-container *ngSwitchCase="stageType.UNWIND">
        In progress
      </ng-container>
      <ng-container *ngSwitchCase="stageType.CUSTOM">
        In progress
      </ng-container>
    </ng-container>
    <mat-action-row>
      <safe-button [isIcon]="true" icon="delete" variant="danger" (click)="deleteStage(index)"></safe-button>
    </mat-action-row>
  </mat-expansion-panel>
</mat-accordion>
<div>
  <safe-button icon="add" category="primary" [matMenuTriggerFor]="menu" [block]="true" (click)="$event.stopPropagation()">
    {{'aggregation.addStage' | translate}}
  </safe-button>
  <mat-menu #menu="matMenu">
      <button *ngFor="let stage of stageList" mat-menu-item (click)="addStage(stage)">
          {{'aggregation.stages.' + stage | translate}}
      </button>
  </mat-menu>
</div>
