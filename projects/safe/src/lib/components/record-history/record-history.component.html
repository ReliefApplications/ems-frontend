<div class="history-header">
  <!-- HEADER -->
  <div>
    <h2>{{ 'common.history' | translate }}</h2>
    <safe-button
      [isIcon]="true"
      icon="close"
      style="float: right"
      (click)="onCancel()"
    >
    </safe-button>
  </div>
  <!-- FILTER -->
  <div style="clear: both; display: flex; flex-direction: column">
    <mat-form-field>
      <mat-date-range-input
        (click)="rangePicker.open()"
        [rangePicker]="rangePicker"
      >
        <input
          #startDate
          (dateInput)="filtersDate['startDate'] = $event.value"
          matStartDate
          placeholder="Start date"
          readonly
        />
        <input
          #endDate
          (dateInput)="filtersDate['endDate'] = $event.value"
          matEndDate
          placeholder="End date"
          readonly
        />
      </mat-date-range-input>
      <mat-datepicker-toggle
        matSuffix
        [for]="rangePicker"
      ></mat-datepicker-toggle>
      <mat-date-range-picker #rangePicker>
        <mat-date-range-picker-actions>
          <safe-button matDateRangePickerCancel (click)="clearDateFilter()">{{
            'common.clear' | translate
          }}</safe-button>
          <safe-button
            category="secondary"
            variant="primary"
            matDateRangePickerApply
            (click)="applyFilter()"
            >{{ 'common.filter.apply' | translate }}</safe-button
          >
        </mat-date-range-picker-actions>
      </mat-date-range-picker>
    </mat-form-field>
  </div>
  <!-- ACTIONS -->
  <div class="actions">
    <safe-button
      category="secondary"
      variant="primary"
      [matMenuTriggerFor]="menu"
    >
      {{ 'components.history.download' | translate }}
    </safe-button>
    <mat-menu #menu="matMenu">
      <button mat-menu-item (click)="onDownload('csv')">.csv</button>
      <button mat-menu-item (click)="onDownload('xlsx')">.xlsx</button>
    </mat-menu>
  </div>
</div>
<!-- LOADING -->
<div class="history-container" *ngIf="loading">
  <ng-container *ngFor="let _ of [].constructor(4)">
    <mat-expansion-panel closed>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <kendo-skeleton width="50%"></kendo-skeleton>
          <kendo-skeleton
            class="history-user"
            width="30%"
            height="2em"
          ></kendo-skeleton>
        </mat-panel-title>
      </mat-expansion-panel-header>
    </mat-expansion-panel>
  </ng-container>
</div>
<!-- HISTORY CHANGES -->
<div class="history-container" *ngIf="!loading">
  <ng-container *ngFor="let item of filterHistory">
    <mat-expansion-panel (closed)="showMore = false">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="history-date">{{
            getDateLocale(item.createdAt, 'date')
          }}</span>
          {{ getDateLocale(item.createdAt, 'time') }}
          <span class="history-user" *ngIf="item.createdBy">{{
            item.createdBy
          }}</span>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <ng-template matExpansionPanelContent>
        <div
          class="changes-content"
          *ngFor="
            let value of showMore ? item.changes : item.changes.slice(0, 4)
          "
          [innerHTML]="getHTMLFromChange(value)"
        ></div>
        <div class="full-history">
          <safe-button
            variant="primary"
            *ngIf="!showMore && item.changes.length > 4"
            (click)="showMore = true"
            >{{ 'common.pagination.loadMore' | translate }} ({{
              item.changes.length - 4
            }})</safe-button
          >
        </div>
        <safe-button
          icon="update"
          class="revert-icon"
          (click)="onRevert(item.version)"
          *ngIf="item.version"
        >
          {{ 'components.history.preview' | translate }}
        </safe-button>
      </ng-template>
    </mat-expansion-panel>
  </ng-container>
  <div *ngIf="filterHistory.length === 0" class="empty-history">
    <safe-icon icon="folder_open"></safe-icon>
    <h3>{{ 'components.history.empty' | translate }}</h3>
  </div>
</div>
