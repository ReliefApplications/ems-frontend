<div *ngIf="!loading">
  <!-- NEW WIDGETS -->
  <div
    class="widget-choice-wrapper"
    *ngIf="canUpdate"
    [ngClass]="{ 'floating-widget-choice-wrapper': widgets.length > 0 }"
  >
    <h2 *ngIf="widgets.length === 0">{{ 'models.widget.add' | translate }}</h2>
    <safe-widget-choice
      [floating]="widgets.length > 0"
      [widgetTypes]="availableWidgets"
      (add)="onAdd($event)"
    >
    </safe-widget-choice>
  </div>
  <!-- GRID OF WIDGETS -->
  <ktd-grid
    [cols]="colsNumber"
    [rowHeight]="200"
    [layout]="layout"
    (resizeEnded)="onEditTile($event)"
    [gap]="16"
    class="-m-4"
  >
    <ktd-grid-item
      *ngFor="let item of layout; let i = index; trackBy:trackById" [id]="widgets[i].id"
      [resizable]="canUpdate"
      [draggable]="canUpdate"
      dragStartThreshold="0"
      class="!rounded-lg !border focus-within:ring-2 focus-within:ring-primary-500 focus-within:ring-offset-2"
      [ngClass]="{
        '!shadow-sm !border-gray-300':
          widgets[i].settings.widgetDisplay?.showBorder ?? true,
        '!border-transparent': !(
          widgets[i].settings.widgetDisplay?.showBorder ?? true
        ),
        'hover:!border-gray-400 hover:!shadow-sm': isBackOffice
      }"
    >
      <!-- <div ktdGridDragHandle style="height: 26px; width: 26px; background-color: pink; position: absolute; z-index: 1050;"></div> -->
      <!-- Settings -->
      <safe-floating-options
        *ngIf="canUpdate"
        class="absolute top-0 right-0 z-[1100]"
        [widget]="widgets[i]"
        (edit)="onEditWidget($event)"
        (delete)="onDeleteWidget($event)"
        (expand)="onExpandWidget($event)"
      >
      </safe-floating-options>
      <safe-widget
        [widget]="widgets[i]"
        (changeStep)="changeStep.emit($event)"
        [id]="'widget-' + widgets[i].id"
        (edit)="onEditWidget($event)"
        [canUpdate]="canUpdate"
        class="bg-white"
      ></safe-widget>
      <!-- Move widget -->
      <div class="absolute cursor-grab top-2 left-2 z-[1100]" ktdGridDragHandle>
        <ui-icon
          *ngIf="canUpdate"
          icon="drag_indicator"
          class="pointer-events-none"
          variant="grey"
        >
        </ui-icon>
      </div>
      <!-- Expand button -->
      <ui-button
        *ngIf="!canUpdate"
        [isIcon]="true"
        icon="open_in_full"
        variant="grey"
        class="absolute top-0 right-0 z-[1100]"
        (click)="onExpandWidget(widgets[i])"
      >
      </ui-button>
      <!-- Placeholder -->
      <ng-template ktdGridItemPlaceholder>
        <div class="w-full h-full border rounded-lg"></div>
      </ng-template>
    </ktd-grid-item>
  </ktd-grid>
</div>
<!-- LOADING INDICATOR -->
<div *ngIf="loading" class="mt-6">
  <kendo-tilelayout [rowHeight]="200" [columns]="colsNumber" class="-m-4">
    <kendo-tilelayout-item
      *ngFor="let skeleton of skeletons"
      [colSpan]="skeleton.colSpan"
      [rowSpan]="skeleton.rowSpan"
    >
      <kendo-skeleton
        shape="rectangle"
        animation="pulse"
        [width]="'100%'"
        [height]="'100%'"
      ></kendo-skeleton>
    </kendo-tilelayout-item>
  </kendo-tilelayout>
</div>
