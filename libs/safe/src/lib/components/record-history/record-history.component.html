<div class="items-center p-4 border-b">
  <!-- HEADER -->
  <div class="flex justify-between items-center mb-2">
    <h2 class="float-left mb-0">{{ 'common.history' | translate }}</h2>
    <safe-button
      [isIcon]="true"
      icon="close"
      class="float-right"
      (click)="onCancel()"
    >
    </safe-button>
  </div>
  <!-- FILTER -->
  <div class="clear-both flex flex-col">
    <mat-form-field appearance="outline">
      <mat-date-range-input
        (click)="rangePicker.open()"
        [rangePicker]="rangePicker"
      >
        <input
          #startDate
          (dateInput)="filtersDate['startDate'] = $event.value"
          matStartDate
          placeholder="Start date"
          readonly
        />
        <input
          #endDate
          (dateInput)="filtersDate['endDate'] = $event.value"
          matEndDate
          placeholder="End date"
          readonly
        />
      </mat-date-range-input>
      <mat-datepicker-toggle
        matSuffix
        [for]="rangePicker"
      ></mat-datepicker-toggle>
      <mat-date-range-picker #rangePicker>
        <mat-date-range-picker-actions>
          <safe-button matDateRangePickerCancel (click)="clearDateFilter()">{{
            'common.clear' | translate
          }}</safe-button>
          <safe-button
            category="secondary"
            variant="primary"
            matDateRangePickerApply
            (click)="applyFilter()"
            >{{ 'common.filter.apply' | translate }}</safe-button
          >
        </mat-date-range-picker-actions>
      </mat-date-range-picker>
    </mat-form-field>
    <mat-form-field appearance="outline">
      <mat-label>{{ 'components.history.field.select' | translate }}</mat-label>
      <mat-select
        (selectionChange)="applyFilter($event.value)"
        [value]="filterFields"
        multiple
      >
        <mat-option
          *ngFor="let field of sortedFields"
          value="{{ field.name }}"
          >{{ field.title || field.name }}</mat-option
        >
      </mat-select>
      <safe-button
        matSuffix
        icon="close"
        [isIcon]="true"
        (click)="applyFilter([]); $event.stopPropagation()"
      ></safe-button>
    </mat-form-field>
  </div>
  <!-- ACTIONS -->
  <div class="flex flex-row justify-start text-end ml-auto">
    <safe-button
      category="secondary"
      variant="primary"
      [uiMenuTriggerFor]="menu"
    >
      {{ 'components.history.download' | translate }}
    </safe-button>
    <ui-menu #menu>
      <button uiMenuItem (click)="onDownload('csv')">.csv</button>
      <button uiMenuItem (click)="onDownload('xlsx')">.xlsx</button>
    </ui-menu>
  </div>
</div>
<!-- LOADING -->
<div class="grow overflow-y-auto" *ngIf="loading">
  <ng-container *ngFor="let _ of [].constructor(4)">
    <mat-expansion-panel closed>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <kendo-skeleton width="50%"></kendo-skeleton>
          <kendo-skeleton
            class="history-user"
            width="30%"
            height="2em"
          ></kendo-skeleton>
        </mat-panel-title>
      </mat-expansion-panel-header>
    </mat-expansion-panel>
  </ng-container>
</div>
<!-- HISTORY CHANGES -->
<div class="history-container" *ngIf="!loading">
  <ng-container *ngFor="let item of filterHistory">
    <mat-expansion-panel (closed)="showMore = false">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="font-bold mr-2">{{
            item.createdAt | safeDate : 'shortDate'
          }}</span>
          {{ item.createdAt | safeDate : 'shortTime' }}
          <span class="history-user" *ngIf="item.createdBy">{{
            item.createdBy
          }}</span>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <ng-template matExpansionPanelContent>
        <div
          class="changes-content"
          *ngFor="
            let value of showMore ? item.changes : item.changes.slice(0, 4)
          "
          [innerHTML]="getHTMLFromChange(value)"
        ></div>
        <div class="text-center mb-3">
          <safe-button
            variant="primary"
            *ngIf="!showMore && item.changes.length > 4"
            (click)="showMore = true"
            >{{ 'common.pagination.loadMore' | translate }} ({{
              item.changes.length - 4
            }})</safe-button
          >
        </div>
        <safe-button
          icon="update"
          class="float-right"
          (click)="onRevert(item.version)"
          *ngIf="item.version"
        >
          {{ 'components.history.preview' | translate }}
        </safe-button>
      </ng-template>
    </mat-expansion-panel>
  </ng-container>
  <safe-empty
    class="m-auto py-6 px-0"
    *ngIf="filterHistory.length === 0"
    [title]="'components.history.empty' | translate"
  ></safe-empty>
</div>
