<!-- todo(gis): translate -->
<div [formGroup]="formGroup" class="flex flex-col gap-y-8">
  <!-- Field -->
  <mat-form-field appearance="outline">
    <mat-label>Field</mat-label>
    <mat-select formControlName="field1">
      <mat-option
        *ngFor="let field of scalarFields$ | async"
        [value]="field.name"
        >{{ field.label }}</mat-option
      >
    </mat-select>
  </mat-form-field>
  <!-- Unique values -->
  <div>
    <div class="flex gap-1 items-center mb-2">
      <h2 class="m-0">Unique values</h2>
      <safe-button
        (click)="onAddInfo()"
        [isIcon]="true"
        icon="add_circle_outline"
        variant="primary"
      ></safe-button>
    </div>

    <ul
      *ngIf="uniqueValueInfos.length > 0"
      class="divide-y divide-gray-100 bg-white ring-1 ring-gray-900/5 rounded-xl mx-2"
      cdkDropList
      (cdkDropListDropped)="onDrop($event)"
    >
      <li
        *ngFor="let info of uniqueValueInfos.controls; let index = index"
        class="hover:bg-gray-50 p-4 flex flex-col divide-y divide-gray-100"
        cdkDrag
      >
        <ng-container *ngIf="index === openedIndex">
          <ng-container
            *ngTemplateOutlet="
              openedTemplate;
              context: { form: uniqueValueInfos.at(index) }
            "
          ></ng-container>
        </ng-container>
        <ng-container *ngIf="index !== openedIndex">
          <ng-container
            *ngTemplateOutlet="
              defaultTemplate;
              context: { value: uniqueValueInfos.at(index).value, index: index }
            "
          ></ng-container>
        </ng-container>
      </li>
    </ul>
  </div>

  <!-- Default -->
  <div>
    <h2>Default</h2>
    <mat-form-field appearance="outline">
      <mat-label>Default label</mat-label>
      <input matInput formControlName="defaultLabel" type="text" />
    </mat-form-field>
    <h3>Symbol</h3>
    <safe-simple-renderer
      [formGroup]="$any(formGroup.get('defaultSymbol'))"
    ></safe-simple-renderer>
  </div>
</div>

<!-- Opened unique value template -->
<ng-template #openedTemplate let-form="form" let-index="index">
  <div class="pb-2">
    <ng-container
      *ngTemplateOutlet="
        headerTemplate;
        context: { value: form.value, index: index }
      "
    ></ng-container>
  </div>
  <div [formGroup]="form" class="flex flex-col pt-2">
    <mat-form-field appearance="outline">
      <mat-label>Label</mat-label>
      <input matInput formControlName="label" type="text" />
    </mat-form-field>
    <mat-form-field appearance="outline">
      <mat-label>Value</mat-label>
      <input matInput formControlName="value" type="text" />
    </mat-form-field>
    <safe-simple-renderer
      [formGroup]="form.get('symbol')"
    ></safe-simple-renderer>
  </div>
</ng-template>

<!-- Default unique value template -->
<ng-template #defaultTemplate let-value="value" let-index="index">
  <ng-container
    *ngTemplateOutlet="headerTemplate; context: { value: value, index: index }"
  ></ng-container>
</ng-template>

<!-- Unique value header template -->
<ng-template #headerTemplate let-value="value" let-index="index">
  <div class="flex justify-between items-center">
    <div class="flex flex-1 gap-4 items-center cursor-pointer">
      <safe-icon
        cdkDraghandle
        icon="drag_indicator"
        variant="grey"
        class="cursor-move"
      ></safe-icon>
      <div class="flex flex-1 gap-2 items-center" (click)="openedIndex = index">
        <i
          [style.color]="value.symbol.color"
          class="{{ value.symbol.style | safeIconDisplay : 'fa' }}"
        ></i>
        <span>{{ value.label }}</span>
      </div>
    </div>
    <safe-button
      (click)="onRemoveInfo(index)"
      [isIcon]="true"
      icon="delete"
      variant="danger"
    ></safe-button>
  </div>
</ng-template>
