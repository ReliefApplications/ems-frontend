<!-- MatSelect between resource or refData origin -->
<ng-container *ngIf="form">
  <form [formGroup]="form" class="w-full">
    <div formGroupName="datasource" class="flex flex-col gap-3 w-full">
      <!-- Origin -->
      <mat-form-field appearance="outline">
        <mat-label>{{
          'components.widget.settings.map.edit.datasource.origin' | translate
        }}</mat-label>
        <mat-select formControlName="origin">
          <mat-option value="resource">{{
            'common.resource.one' | translate
          }}</mat-option>
          <mat-option value="refData">{{
            'common.referenceData.one' | translate
          }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Resource selection -->
      <mat-form-field
        appearance="outline"
        class="flex-1"
        *ngIf="form.get('datasource.origin')?.value === 'resource'"
      >
        <mat-label>{{ 'common.resource.one' | translate }}</mat-label>
        <safe-graphql-select
          valueField="id"
          textField="name"
          [query]="resourcesQuery"
          formControlName="resource"
          [selectedElements]="[resource]"
          (searchChange)="onResourceSearchChange($event)"
          [filterable]="true"
        >
        </safe-graphql-select>
      </mat-form-field>

      <!-- Aggregation or layout selection -->
      <div
        class="flex flex-col gap-8"
        *ngIf="resource && !layout && !aggregation"
      >
        <h2>{{ 'common.layout.one' | translate }}</h2>
        <div class="flex justify-center mt-4">
          <safe-button
            class="max-w-xs grow"
            category="tertiary"
            variant="primary"
            (click)="selectLayout()"
            >{{
              'components.widget.settings.grid.layouts.add.select' | translate
            }}</safe-button
          >
        </div>
        <safe-divider
          *ngIf="!layout && !aggregation"
          [text]="'common.or' | translate"
        ></safe-divider>
        <h2>{{ 'common.aggregation.one' | translate }}</h2>
        <div class="flex justify-center mt-4">
          <safe-button
            class="max-w-xs grow"
            category="tertiary"
            variant="primary"
            (click)="selectAggregation()"
            >{{ 'components.aggregation.add.select' | translate }}</safe-button
          >
        </div>
      </div>

      <!-- Selected layout -->
      <mat-form-field appearance="outline" *ngIf="layout">
        <mat-label>{{ 'common.layout.one' | translate }}</mat-label>
        <mat-select [disabled]="true" [value]="layout.id">
          <mat-option [value]="layout.id">{{ layout.name }}</mat-option>
        </mat-select>
        <safe-button
          matSuffix
          variant="primary"
          [isIcon]="true"
          icon="edit"
          (click)="editLayout()"
        ></safe-button>
        <safe-button
          matSuffix
          variant="danger"
          [isIcon]="true"
          icon="close"
          (click)="form.get('datasource.layout')?.setValue(null); layout = null"
        ></safe-button>
      </mat-form-field>

      <!-- Selected aggregation -->
      <mat-form-field appearance="outline" *ngIf="aggregation">
        <mat-label>{{ 'common.aggregation.one' | translate }}</mat-label>
        <mat-select [disabled]="true" [value]="aggregation.id">
          <mat-option [value]="aggregation.id">{{
            aggregation.name
          }}</mat-option>
        </mat-select>
        <safe-button
          matSuffix
          variant="primary"
          [isIcon]="true"
          icon="edit"
          (click)="editAggregation()"
        ></safe-button>
        <safe-button
          matSuffix
          variant="danger"
          [isIcon]="true"
          icon="close"
          (click)="
            form.get('datasource.aggregation')?.setValue(null);
            aggregation = null
          "
        ></safe-button>
      </mat-form-field>

      <!-- Reference data selection  -->
      <mat-form-field
        appearance="outline"
        class="flex-1"
        *ngIf="form.get('datasource.origin')?.value === 'refData'"
      >
        <mat-label>{{ 'common.referenceData.one' | translate }}</mat-label>
        <safe-graphql-select
          valueField="id"
          textField="name"
          [query]="refDatasQuery"
          formControlName="refData"
          [selectedElements]="[refData]"
        >
        </safe-graphql-select>
      </mat-form-field>

      <!-- Fields selection-->
      <ng-container
        *ngIf="
          (form.get('datasource.origin')?.value === 'resource' &&
            (form.get('datasource.layout')?.value ||
              form.get('datasource.aggregation')?.value)) ||
          (form.get('datasource.origin')?.value === 'reference' &&
            form.get('datasource.refData')?.value)
        "
      >
        <!-- Geo Field -->
        <mat-form-field appearance="outline">
          <mat-label>{{
            'components.widget.settings.map.edit.datasource.geoField'
              | translate
          }}</mat-label>
          <mat-select formControlName="geoField">
            <mat-option *ngFor="let record of records" [value]="record.name">{{
              record.name ?? (record.translation | translate)
            }}</mat-option>
          </mat-select>
        </mat-form-field>
        <!-- Latitude Field -->
        <mat-form-field appearance="outline">
          <mat-label>{{
            'components.widget.settings.map.edit.datasource.latitudeField'
              | translate
          }}</mat-label>
          <mat-select formControlName="latitudeField">
            <mat-option *ngFor="let record of records" [value]="record.name">{{
              record.name ?? (record.translation | translate)
            }}</mat-option>
          </mat-select>
        </mat-form-field>
        <!-- Longitude Field -->
        <mat-form-field appearance="outline">
          <mat-label>{{
            'components.widget.settings.map.edit.datasource.longitudeField'
              | translate
          }}</mat-label>
          <mat-select formControlName="longitudeField">
            <mat-option *ngFor="let record of records" [value]="record.name">{{
              record.name ?? (record.translation | translate)
            }}</mat-option>
          </mat-select>
        </mat-form-field>
      </ng-container>
    </div>
  </form>
</ng-container>
