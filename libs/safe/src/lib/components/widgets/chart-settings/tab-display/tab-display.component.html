<div>
  <h2>{{ 'common.display' | translate }}</h2>
  <form [formGroup]="formGroup" class="flex flex-row h-full">
    <!-- Chart options -->
    <div class="flex flex-1 flex-col" formGroupName="chart">
      <cdk-accordion>
        <!-- === LEGEND === -->
        <ui-expansion-panel formGroupName="legend">
          <ng-container ngProjectAs="title">
            {{ 'components.widget.settings.chart.legend' | translate }}
          </ng-container>
          <div>
            <mat-form-field appearance="outline">
              <mat-label>{{
                'components.widget.settings.chart.position' | translate
              }}</mat-label>
              <mat-select formControlName="position">
                <mat-select-trigger>
                  {{ chartForm.value.legend.position }}
                </mat-select-trigger>
                <mat-option value="none">{{
                  'components.widget.settings.chart.hideLegend' | translate
                }}</mat-option>
                <mat-option
                  *ngFor="let position of legendPositions"
                  value="{{ position.value }}"
                >
                  <div class="flex">
                    <span class="flex w-full items-center justify-between"
                      >{{ position.value }}
                      <safe-icon
                        [inline]="true"
                        icon="{{ position.icon }}"
                      ></safe-icon>
                    </span>
                  </div>
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </ui-expansion-panel>
        <!-- === TITLE === -->
        <ui-expansion-panel formGroupName="title" [index]="1">
          <ng-container ngProjectAs="title">
            {{ 'common.title' | translate }}
          </ng-container>
          <div class="flex flex-col gap-2">
            <!-- Text -->
            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>{{
                'components.widget.settings.chart.text' | translate
              }}</mat-label>
              <input matInput formControlName="text" />
            </mat-form-field>
            <div class="flex gap-2 items-center">
              <!-- Font size -->
              <mat-form-field appearance="outline" class="flex-1">
                <mat-label>{{
                  'components.widget.settings.chart.size' | translate
                }}</mat-label>
                <mat-select formControlName="size">
                  <mat-option *ngFor="let size of sizes" [value]="size">
                    {{ size }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <!-- Position -->
              <mat-form-field appearance="outline" class="flex-1">
                <mat-label>{{
                  'components.widget.settings.chart.position' | translate
                }}</mat-label>
                <mat-select formControlName="position">
                  <mat-select-trigger>
                    {{ chartForm.value.title.position }}
                  </mat-select-trigger>
                  <mat-option
                    *ngFor="let position of titlePositions"
                    value="{{ position.value }}"
                  >
                    <div class="flex">
                      <span class="flex w-full items-center justify-between"
                        >{{ position.value }}
                        <safe-icon
                          [inline]="true"
                          icon="{{ position.icon }}"
                        ></safe-icon>
                      </span>
                    </div>
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="flex gap-2 items-center">
              <!-- Format -->
              <div class="flex-1 flex flex-col">
                <span class="text-gray-500 mb-1 text-xs">{{
                  'components.widget.settings.chart.title.format' | translate
                }}</span>
                <div class="flex">
                  <ng-container
                    *ngIf="chartForm.get('title.bold'); let control"
                  >
                    <safe-button
                      icon="format_bold"
                      (click)="onToggleStyle('title.bold')"
                      [category]="control.value ? 'secondary' : 'tertiary'"
                      [variant]="control.value && 'primary'"
                      [disabled]="control.disabled"
                    ></safe-button>
                  </ng-container>
                  <ng-container
                    *ngIf="chartForm.get('title.italic'); let control"
                  >
                    <safe-button
                      icon="format_italic"
                      (click)="onToggleStyle('title.italic')"
                      [category]="control.value ? 'secondary' : 'tertiary'"
                      [variant]="control.value && 'primary'"
                      [disabled]="control.disabled"
                    ></safe-button>
                  </ng-container>
                  <ng-container
                    *ngIf="chartForm.get('title.underline'); let control"
                  >
                    <safe-button
                      (click)="onToggleStyle('title.underline')"
                      icon="format_underline"
                      [category]="control.value ? 'secondary' : 'tertiary'"
                      [variant]="control.value && 'primary'"
                      [disabled]="control.disabled"
                    ></safe-button>
                  </ng-container>
                </div>
              </div>
              <!-- Color -->
              <div class="flex-1 flex flex-col">
                <span class="text-gray-500 mb-1 text-xs">{{
                  'components.widget.settings.chart.title.color' | translate
                }}</span>
                <kendo-colorpicker formControlName="color"></kendo-colorpicker>
              </div>
            </div>
          </div>
        </ui-expansion-panel>
        <!-- === PALETTE -->
        <ui-expansion-panel 
          formGroupName="palette" [index]="2">
          <ng-container ngProjectAs="title">
            {{ 'components.widget.settings.chart.palette.title' | translate }}
          </ng-container>
          <div class="flex flex-col gap-2">
            <ui-toggle formControlName="enabled">
              <ng-container ngProjectAs="label">
                {{
                  'components.widget.settings.chart.palette.enable' | translate
                }}<safe-icon
                  class="ml-2"
                  variant="grey"
                  [inline]="true"
                  [size]="18"
                  icon="info_outline"
                  [uiTooltip]="
                    'components.widget.settings.chart.tooltip.palette'
                      | translate
                  "
                ></safe-icon>
              </ng-container>
            </ui-toggle>
            <safe-palette-control
              formControlName="value"
            ></safe-palette-control>
          </div>
        </ui-expansion-panel>
        <!-- === LABELS === -->
        <ui-expansion-panel formGroupName="labels" [index]="3">
          <ng-container ngProjectAs="title">
            {{ 'components.widget.settings.chart.labels.title' | translate }}
          </ng-container>
          <div class="flex flex-col gap-2">
            <ui-toggle
              formControlName="showCategory"
              *ngIf="type.name === 'donut' || type.name === 'pie'"
            >
              <ng-container ngProjectAs="label">{{
                'components.widget.settings.chart.labels.showCategory'
                  | translate
              }}</ng-container>
            </ui-toggle>
            <ui-toggle formControlName="showValue">
              <ng-container ngProjectAs="label">{{
                'components.widget.settings.chart.labels.showValue' | translate
              }}</ng-container>
            </ui-toggle>
            <mat-form-field
              appearance="outline"
              *ngIf="
                chartForm.value.labels.showValue &&
                (['donut', 'pie'].includes(type.name) ||
                  (['bar', 'column'].includes(type.name) &&
                    chartForm.value.mapping.series))
              "
            >
              <mat-label>{{
                'components.widget.settings.chart.labels.valueType' | translate
              }}</mat-label>
              <mat-select formControlName="valueType">
                <mat-option value="value">{{
                  'common.value.one' | translate
                }}</mat-option>
                <mat-option value="percentage">{{
                  'components.widget.settings.chart.labels.percentage'
                    | translate
                }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </ui-expansion-panel>
        <!-- === AXES PARAMETERS === -->
        <ui-expansion-panel 
          formGroupName="axes"
          *ngIf="['bar', 'column'].includes(type.name)"
          [index]="4"
        >
          <ng-container ngProjectAs="title">
            {{ 'components.widget.settings.chart.axes' | translate }}
          </ng-container>
          <!-- === X AXIS PARAMETERS === -->
          <ng-container formGroupName="x" *ngIf="['bar'].includes(type.name)">
            <h3>
              {{ 'components.widget.settings.chart.xAxis' | translate }}
            </h3>
            <div class="axis-container">
              <ui-toggle formControlName="enableMin"></ui-toggle>
              <mat-form-field appearance="outline" floatLabel="always">
                <mat-label>{{
                  'components.aggregationBuilder.operators.min' | translate
                }}</mat-label>
                <input
                  matInput
                  formControlName="min"
                  type="number"
                  [placeholder]="'common.auto' | translate"
                />
              </mat-form-field>
            </div>
            <div class="axis-container">
              <ui-toggle formControlName="enableMax"></ui-toggle>
              <mat-form-field appearance="outline" floatLabel="always">
                <mat-label>{{
                  'components.aggregationBuilder.operators.max' | translate
                }}</mat-label>
                <input
                  matInput
                  formControlName="max"
                  type="number"
                  [placeholder]="'common.auto' | translate"
                />
              </mat-form-field>
            </div>
          </ng-container>
          <!-- === Y AXIS PARAMETERS === -->
          <ng-container
            formGroupName="y"
            *ngIf="['column'].includes(type.name)"
          >
            <h3>
              {{ 'components.widget.settings.chart.yAxis' | translate }}
            </h3>
            <div class="axis-container">
              <ui-toggle formControlName="enableMin"></ui-toggle>
              <mat-form-field appearance="outline" floatLabel="always">
                <mat-label>{{
                  'components.aggregationBuilder.operators.min' | translate
                }}</mat-label>
                <input
                  matInput
                  formControlName="min"
                  type="number"
                  [placeholder]="'common.auto' | translate"
                />
              </mat-form-field>
            </div>
            <div class="axis-container">
              <ui-toggle formControlName="enableMax"></ui-toggle>
              <mat-form-field appearance="outline" floatLabel="always">
                <mat-label>{{
                  'components.aggregationBuilder.operators.max' | translate
                }}</mat-label>
                <input
                  matInput
                  formControlName="max"
                  type="number"
                  [placeholder]="'common.auto' | translate"
                />
              </mat-form-field>
            </div>
          </ng-container>
        </ui-expansion-panel>
        <!-- === DISPLAY GRIDS === -->
        <ui-expansion-panel 
          formGroupName="grid"
          *ngIf="['bar', 'column', 'line'].includes(type.name)"
          [index]="5"
        >
          <ng-container ngProjectAs="title">
            {{ 'components.widget.settings.chart.grid.title' | translate }}
          </ng-container>
          <div class="flex flex-col gap-2" formGroupName="x">
            <ui-toggle formControlName="display">
              <ng-container ngProjectAs="label">{{
                'components.widget.settings.chart.grid.x.display' | translate
              }}</ng-container>
            </ui-toggle>
          </div>
          <div class="flex flex-col gap-2 mt-2" formGroupName="y">
            <ui-toggle formControlName="display">
              <ng-container ngProjectAs="label">{{
                'components.widget.settings.chart.grid.y.display' | translate
              }}</ng-container>
            </ui-toggle>
          </div>
        </ui-expansion-panel>
        <!-- === SERIES AND STACKS PARAMETERS === -->
        <ui-expansion-panel [index]="6">
          <ng-container ngProjectAs="title">
            {{ 'components.widget.settings.chart.series.title' | translate }}
          </ng-container>
          <div
            class="flex flex-col gap-2 mb-6"
            formGroupName="stack"
            *ngIf="
              ['bar', 'column'].includes(type.name) &&
              chartForm.value.mapping.series
            "
          >
            <ui-toggle formControlName="enable">
              <ng-container ngProjectAs="label">{{
                'components.widget.settings.chart.series.stack.enable'
                  | translate
              }}</ng-container>
            </ui-toggle>
            <ui-toggle formControlName="usePercentage">
              <ng-container ngProjectAs="label">{{
                'components.widget.settings.chart.series.stack.usePercentage'
                  | translate
              }}</ng-container>
            </ui-toggle>
            <ui-divider></ui-divider>
          </div>
          <safe-series-settings
            [formArray]="$any(formGroup.get('chart.series'))"
          >
          </safe-series-settings>
        </ui-expansion-panel>
      </cdk-accordion>
    </div>
    <!-- Chart preview -->
    <div class="flex flex-1 flex-col h-96">
      <safe-chart
        class="h-full"
        [header]="false"
        [export]="false"
        [settings]="chartSettings"
      >
      </safe-chart>
    </div>
  </form>
</div>
