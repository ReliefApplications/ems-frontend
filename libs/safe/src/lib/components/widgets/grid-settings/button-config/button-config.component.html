<form [formGroup]="formGroup" class="flex">
  <div class="flex flex-col w-full">
    <div class="flex justify-between">
      <ui-toggle formControlName="show">
        <ng-container ngProjectAs="label">{{
          'components.widget.settings.grid.buttons.enable' | translate
        }}</ng-container>
      </ui-toggle>
      <safe-button
        icon="remove_circle_outline"
        variant="danger"
        (click)="emitDeleteButton()"
      >
        {{ 'common.delete' | translate }}
      </safe-button>
    </div>
    <ng-container *ngIf="formGroup.value.show">
      <!-- Name -->
      <mat-form-field appearance="outline">
        <mat-label>{{ 'common.name' | translate }}</mat-label>
        <input matInput formControlName="name" type="string" />
      </mat-form-field>

      <!-- Select all records of query -->
      <ui-checkbox formControlName="selectAll">
        <ng-container ngProjectAs="label">{{
          'components.widget.settings.grid.buttons.callback.selectAllRecords'
            | translate
        }}</ng-container>
      </ui-checkbox>

      <!-- Select only visible records -->
      <ui-checkbox formControlName="selectPage">
        <ng-container ngProjectAs="label">{{
          'components.widget.settings.grid.buttons.callback.selectAllRecordsActivePage'
            | translate
        }}</ng-container>
      </ui-checkbox>

      <!-- Prefill form with selected records -->
      <ng-container *ngIf="relatedForms.length > 0">
        <ui-checkbox formControlName="prefillForm">
          <ng-container ngProjectAs="label">{{
            'components.widget.settings.grid.buttons.callback.prefill' | translate
          }}</ng-container>
        </ui-checkbox>
        <div *ngIf="formGroup.value.prefillForm" class="sub-parameters">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'models.form.template' | translate }}</mat-label>
            <mat-select formControlName="prefillTargetForm">
              <mat-option>--</mat-option>
              <mat-option *ngFor="let form of relatedForms" [value]="form.id">
                {{ form.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </ng-container>

      <!-- Workflow actions -->
      <ng-container *ngIf="!isDashboard">
        <!-- Go to next step -->
        <ui-checkbox formControlName="goToNextStep">
          <ng-container ngProjectAs="label">{{
            'components.widget.settings.grid.buttons.callback.workflow.next'
              | translate
          }}</ng-container>
        </ui-checkbox>
        <!-- Close workflow -->
        <ui-checkbox formControlName="closeWorkflow">
          <ng-container ngProjectAs="label">{{
            'components.widget.settings.grid.buttons.callback.workflow.close'
              | translate
          }}</ng-container>
        </ui-checkbox>
        <!-- Confirm action -->
        <mat-form-field
          appearance="outline"
          class="sub-parameters"
          *ngIf="formGroup.value.closeWorkflow"
        >
          <mat-label>{{
            'components.widget.settings.grid.buttons.callback.workflow.confirm'
              | translate
          }}</mat-label>
          <input matInput formControlName="confirmationText" type="string" />
        </mat-form-field>
      </ng-container>

      <!-- Auto save edited records -->
      <ui-checkbox formControlName="autoSave">
        <ng-container ngProjectAs="label">{{
          'components.widget.settings.grid.buttons.callback.save' | translate
        }}</ng-container>
      </ui-checkbox>

      <!-- Auto edition of selected records -->
      <div class="flex flex-col">
        <ui-checkbox formControlName="modifySelectedRows">
          <ng-container ngProjectAs="label">{{
            'components.widget.settings.grid.buttons.callback.modify' | translate
          }}</ng-container>
        </ui-checkbox>
        <div
          *ngIf="formGroup.value.modifySelectedRows"
          class="sub-parameters flex flex-col"
        >
          <form
            [formGroup]="$any(modification)"
            *ngFor="let modification of modificationsArray.controls; index as i"
            class="update-row"
          >
            <mat-form-field appearance="outline">
              <mat-label>{{
                'components.widget.settings.grid.buttons.callback.modifyField'
                  | translate
              }}</mat-label>
              <mat-select formControlName="field" [compareWith]="compareFields">
                <mat-option>--</mat-option>
                <mat-option
                  *ngFor="let field of scalarFields"
                  [value]="field"
                  >{{ field.name }}</mat-option
                >
              </mat-select>
            </mat-form-field>
            <mat-form-field
              appearance="outline"
              *ngIf="modification.value.field"
            >
              <mat-label>{{
                'components.widget.settings.grid.buttons.callback.modifyValue'
                  | translate
              }}</mat-label>
              <ng-container
                *ngIf="
                  ['Int', 'Float'].includes(modification.value.field.type.name)
                "
              >
                <input matInput formControlName="value" type="number" />
              </ng-container>
              <ng-container
                *ngIf="modification.value.field.type.name === 'Boolean'"
              >
                <mat-select formControlName="value">
                  <mat-option>--</mat-option>
                  <mat-option [value]="true">{{
                    'common.true' | translate
                  }}</mat-option>
                  <mat-option [value]="false">{{
                    'common.false' | translate
                  }}</mat-option>
                </mat-select>
              </ng-container>
              <ng-container
                *ngIf="
                  !['Int', 'Float'].includes(
                    modification.value.field.type.name
                  ) && modification.value.field.type.name !== 'Boolean'
                "
              >
                <input matInput formControlName="value" type="string" />
              </ng-container>
            </mat-form-field>
            <safe-button
              [isIcon]="true"
              icon="remove_circle_outline"
              variant="danger"
              (click)="onDeleteModification(i)"
            >
            </safe-button>
          </form>
          <safe-button
            [isIcon]="true"
            icon="add_circle_outline"
            variant="primary"
            (click)="onAddModification()"
          >
          </safe-button>
        </div>
      </div>

      <!-- Attach record to another resource record -->
      <ng-container *ngIf="relatedForms.length > 0">
        <ui-checkbox formControlName="attachToRecord">
          <ng-container ngProjectAs="label">
            {{
              'components.widget.settings.grid.buttons.callback.attach'
                | translate
            }}
          </ng-container>
          <ng-container ngProjectAs="icon">
            <safe-icon
              icon="info_outline"
              variant="grey"
              [inline]="true"
              [size]="18"
              [uiTooltip]="
                'components.widget.settings.grid.buttons.tooltip.attach'
                  | translate
              "
            ></safe-icon>
          </ng-container>
        </ui-checkbox>
      </ng-container>
      <div *ngIf="formGroup.value.attachToRecord" class="sub-parameters">
        <!-- Selection of target resource -->
        <mat-form-field appearance="outline">
          <mat-label>{{ 'common.resource.one' | translate }}</mat-label>
          <mat-select formControlName="targetResource">
            <mat-option>--</mat-option>
            <mat-option
              *ngFor="let resource of relatedResources"
              [value]="resource.id"
            >
              {{ resource.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <!-- Selection of target template -->
        <mat-form-field appearance="outline" *ngIf="targetResource">
          <mat-label>{{ 'models.form.select' | translate }}</mat-label>
          <mat-select formControlName="targetForm">
            <mat-option>--</mat-option>
            <mat-option
              *ngFor="let form of targetResource.forms"
              [value]="form.id"
            >
              {{ form.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <ng-container *ngIf="targetResource">
          <!-- Single field to display for quick selection -->
          <mat-form-field appearance="outline">
            <mat-label>{{
              'components.widget.settings.grid.buttons.callback.displayField'
                | translate
            }}</mat-label>
            <mat-select formControlName="targetFormField">
              <mat-option>--</mat-option>
              <mat-option
                *ngFor="let field of targetResource.fields"
                [value]="field.name"
              >
                {{ field.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </ng-container>
        <ng-container *ngIf="targetResource">
          <!-- Selection of fields to display for advanced selection -->
          <safe-query-builder
            [form]="$any(formGroup.controls.targetFormQuery)"
            [canSelectDataSet]="false"
          >
          </safe-query-builder>
        </ng-container>
      </div>

      <!-- Send notification -->
      <ui-checkbox formControlName="notify">
        <ng-container ngProjectAs="label">
          {{ 'components.channel.dropdown.select' | translate }}
        </ng-container>
        <ng-container ngProjectAs="icon">
          <safe-icon
            icon="info_outline"
            variant="grey"
            [size]="18"
            [inline]="true"
            [uiTooltip]="
              'components.widget.settings.grid.buttons.tooltip.notify' | translate
            "
          ></safe-icon>
        </ng-container>
      </ui-checkbox>
      <div *ngIf="formGroup.value.notify" class="sub-parameters">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'common.channel.one' | translate }}</mat-label>
          <mat-select formControlName="notificationChannel">
            <mat-option>--</mat-option>
            <mat-option *ngFor="let channel of channels" [value]="channel.id">
              {{ channel.title }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>{{
            'components.widget.settings.grid.buttons.callback.notify.message'
              | translate
          }}</mat-label>
          <input matInput formControlName="notificationMessage" type="string" />
        </mat-form-field>
      </div>

      <!-- Publish on a channel -->
      <ui-checkbox formControlName="publish">
        <ng-container ngProjectAs="label">
          {{ 'common.publish' | translate }}
        </ng-container>
        <ng-container ngProjectAs="icon">
          <safe-icon
            icon="info_outline"
            variant="grey"
            [size]="18"
            [inline]="true"
            [uiTooltip]="
              'components.widget.settings.grid.buttons.tooltip.publish'
                | translate
            "
            matTooltipPosition="right"
          ></safe-icon>
        </ng-container>
      </ui-checkbox>
      <div *ngIf="formGroup.value.publish" class="sub-parameters">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'common.channel.one' | translate }}</mat-label>
          <mat-select formControlName="publicationChannel">
            <mat-option>--</mat-option>
            <mat-option *ngFor="let channel of channels" [value]="channel.id">
              {{ channel.title }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Send email -->
      <ui-checkbox formControlName="sendMail">
        <ng-container ngProjectAs="label">{{
          'components.widget.settings.grid.buttons.callback.sendMail' | translate
        }}</ng-container>
      </ui-checkbox>
      <div *ngIf="formGroup.value.sendMail" class="sub-parameters">
        <!-- Distribution list -->
        <mat-form-field appearance="outline">
          <mat-label>{{
            'components.emailBuilder.distribution' | translate
          }}</mat-label>
          <mat-select formControlName="distributionList">
            <mat-option
              *ngFor="let list of distributionLists"
              [value]="list.id"
            >
              {{ list.name }}
            </mat-option>
          </mat-select>
          <safe-icon
            matSuffix
            icon="info_outline"
            class="cursor-pointer"
            variant="grey"
            matSuffix
            [uiTooltip]="
              'components.widget.settings.grid.buttons.tooltip.mail.selectDistributionList'
                | translate
            "
          ></safe-icon>
          <safe-button
            matSuffix
            [isIcon]="true"
            icon="add_circle_outline"
            variant="primary"
            (click)="$event.stopPropagation(); addDistributionList()"
            [uiTooltip]="'components.distributionLists.edit.new' | translate"
          >
          </safe-button>
        </mat-form-field>
        <!-- Templates -->
        <mat-form-field appearance="outline">
          <mat-label>{{
            'components.templates.available' | translate
          }}</mat-label>
          <mat-select
            uiErrorMessage="{{
              'components.templates.errors.empty' | translate
            }}"
            [uiErrorMessageIf]="
              formGroup.get('sendMail')?.value &&
              !formGroup.get('templates')?.valid
            "
            class="select"
            formControlName="templates"
            multiple
          >
            <mat-option
              *ngFor="let template of mailTemplates"
              [value]="template.id"
            >
              {{ template.name }}
            </mat-option>
          </mat-select>
          <safe-icon
            matSuffix
            icon="info_outline"
            class="cursor-pointer"
            variant="grey"
            matSuffix
            [uiTooltip]="
              'components.widget.settings.grid.buttons.tooltip.mail.selectTemplates'
                | translate
            "
          ></safe-icon>
          <safe-button
            matSuffix
            [isIcon]="true"
            icon="add_circle_outline"
            variant="primary"
            (click)="$event.stopPropagation(); addEmailTemplate()"
            [uiTooltip]="'components.templates.edit.new' | translate"
          >
          </safe-button>
        </mat-form-field>
        <!-- Export dataset -->
        <ui-checkbox formControlName="export">
          <ng-container ngProjectAs="label">{{
            'components.widget.settings.grid.buttons.callback.export' | translate
          }}</ng-container>
        </ui-checkbox>
        <!-- Select fields to see in dataset -->
        <h2>{{ 'components.emailBuilder.fields' | translate }}</h2>
        <safe-tab-fields
          *ngIf="fields.length > 0"
          [form]="$any(formGroup.controls.bodyFields)"
          [fields]="fields"
          [showLimit]="true"
        ></safe-tab-fields>
      </div>
    </ng-container>
  </div>
</form>
