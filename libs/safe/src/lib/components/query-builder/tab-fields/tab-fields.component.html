<!-- General info about field selection -->
<safe-alert class="mb-4">
  <safe-icon icon="info"></safe-icon>
  {{ 'components.queryBuilder.hint.fields' | translate }}
</safe-alert>
<!-- Field selection -->
<div
  cdkDropListGroup
  class="flex overflow-auto mb-10 gap-6"
  [ngClass]="{ hidden: fieldForm }"
>
  <!-- Available fields -->
  <div class="flex-1 min-w-[400px]" *ngIf="!fieldForm">
    <h2>{{ 'components.queryBuilder.fields.available' | translate }}</h2>

    <!-- Search through fields -->
    <mat-form-field appearance="outline" class="!w-full">
      <mat-label>{{
        'components.queryBuilder.fields.search' | translate
      }}</mat-label>
      <input type="text" matInput [(ngModel)]="searchAvailable" />
      <ui-button
        matSuffix
        (click)="searchAvailable = ''"
        [isIcon]="true"
        [icon]="searchAvailable ? 'cancel' : 'search'"
      ></ui-button>
    </mat-form-field>

    <!-- List of fields -->
    <div class="overflow-auto max-h-[400px]">
      <div
        cdkDropList
        [cdkDropListData]="availableFields"
        class="field-list"
        cdkDropListSortingDisabled
        (cdkDropListDropped)="drop($event)"
      >
        <ng-container *ngFor="let field of availableFields">
          <div
            class="field-box"
            cdkDrag
            *ngIf="
              searchAvailable.length < 1 ||
              field.name.toLowerCase().includes(searchAvailable.toLowerCase())
            "
          >
            {{ field.name }}
            <span class="text-gray-500" *ngIf="field.type.kind !== 'SCALAR'">
              {{ field.type.kind }}
            </span>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Selected fields -->
  <div class="flex-1 min-w-[400px]" *ngIf="!fieldForm">
    <h2>{{ 'components.queryBuilder.fields.selected' | translate }}</h2>

    <!-- Search through fields -->
    <mat-form-field appearance="outline" class="!w-full">
      <mat-label>{{
        'components.queryBuilder.fields.search' | translate
      }}</mat-label>
      <input type="text" matInput [(ngModel)]="searchSelected" />
      <ui-button
        matSuffix
        (click)="searchSelected = ''"
        [isIcon]="true"
        [icon]="searchSelected ? 'cancel' : 'search'"
      ></ui-button>
    </mat-form-field>

    <!-- List of fields -->
    <div class="overflow-auto max-h-[400px]">
      <div
        cdkDropList
        [cdkDropListData]="selectedFields"
        [cdkDropListSortingDisabled]="searchSelected.length > 0"
        class="field-list"
        (cdkDropListDropped)="drop($event)"
      >
        <ng-container *ngFor="let field of selectedFields; let index = index">
          <div
            class="field-box"
            *ngIf="
              searchSelected.length < 1 ||
              field.name.toLowerCase().includes(searchSelected.toLowerCase())
            "
            cdkDrag
          >
            <!-- Field name and errors -->
            <div class="flex items-center">
              <span>{{ field.name }}</span>
              <ui-button
                [isIcon]="true"
                icon="error"
                class="text-red-600"
                (click)="onEdit(index)"
                *ngIf="form.at(index)?.invalid && field.type"
              >
              </ui-button>
              <ui-button
                [isIcon]="true"
                icon="close"
                class="text-red-600"
                *ngIf="!field.type"
                (click)="onDelete(index)"
                [uiTooltip]="
                  'components.queryBuilder.errors.field.invalid' | translate
                "
              >
              </ui-button>
            </div>
            <!-- Field type -->
            <div *ngIf="field.type" class="flex items-center">
              <span
                class="text-gray-500"
                *ngIf="field.type.kind !== 'SCALAR'"
                >{{ field.type.kind }}</span
              >
              <ui-button [isIcon]="true" icon="edit" (click)="onEdit(index)">
              </ui-button>
            </div>
          </div>
        </ng-container>
      </div>
      <safe-icon
        *ngIf="searchSelected"
        icon="info"
        class="floating-info cursor-pointer"
        variant="grey"
        [size]="32"
        [uiTooltip]="
          'components.queryBuilder.hint.sortingDisabled' | translate
        "
      ></safe-icon>
    </div>
  </div>

</div>
<!-- Edited field -->
<div class="flex-1" *ngIf="fieldForm">
  <ng-container *ngIf="fieldForm.value.kind === 'SCALAR'">
    <form
      [formGroup]="fieldForm"
      class="p-4 rounded-lg border border-gray-300"
    >
      <div class="flex gap-2">
        <ui-button
          [isIcon]="true"
          icon="arrow_back"
          (click)="onCloseField()"
        >
        </ui-button>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'models.form.field.name' | translate }}</mat-label>
          <input
            matInput
            formControlName="name"
            type="text"
            [disabled]="true"
          />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'models.form.field.label' | translate }}</mat-label>
          <input matInput formControlName="label" type="text" />
        </mat-form-field>
      </div>
      <h3 style="margin: 0">
        {{ 'components.queryBuilder.fields.format.title' | translate }}
      </h3>
      <div class="info-text" style="margin-bottom: 10px">
        {{ 'components.queryBuilder.fields.format.info' | translate }}
      </div>
      <editor [init]="editor" formControlName="format"></editor>
    </form>
  </ng-container>
  <ng-container
    *ngIf="fieldForm.value.kind !== 'SCALAR'"
    [ngTemplateOutlet]="childTemplate"
  ></ng-container>
</div>
<ng-template #childTemplate></ng-template>
