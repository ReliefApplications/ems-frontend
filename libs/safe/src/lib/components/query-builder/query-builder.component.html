<ng-container *ngIf="form">
  <form [formGroup]="form" [ngClass]="{ 'field-form': isField }">
    <div>
      <div uiFormFieldDirective [outline]="false" *ngIf="!isField && canSelectDataSet">
        <label>{{
          'components.queryBuilder.dataset.select' | translate
        }}</label>
        <input
          type="text"
          [placeholder]="'components.queryBuilder.dataset.select' | translate"
          formControlName="name"
          [matAutocomplete]="auto"
        />
        <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete">
          <mat-option *ngFor="let option of filteredQueries" [value]="option">
            {{ option }}
          </mat-option>
        </mat-autocomplete>
        <ui-icon
          *ngIf="canSelectDataSet && form.invalid"
          uiSuffix
          icon="error"
          [variant]="colorVariant.DANGER"
          [uiTooltip]="'components.form.layout.errors.invalid' | translate"
        ></ui-icon>
      </div>

      <mat-form-field
        appearance="outline"
        *ngIf="!isField && canSelectDataSet && templates.length > 0"
      >
        <mat-label>{{ 'models.form.template' | translate }}</mat-label>
        <mat-select formControlName="template">
          <mat-option>-</mat-option>
          <mat-option
            *ngFor="let template of templates"
            [value]="template.id"
            >{{ template.name }}</mat-option
          >
        </mat-select>
      </mat-form-field>
    </div>

    <ng-container *ngIf="isField">
      <div class="flex gap-2">
        <safe-button [isIcon]="true" icon="arrow_back" (click)="onCloseField()">
        </safe-button>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'models.form.field.name' | translate }}</mat-label>
          <input matInput formControlName="name" type="text" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'models.form.field.label' | translate }}</mat-label>
          <input matInput formControlName="label" type="text" />
        </mat-form-field>
      </div>
    </ng-container>
    <ui-tabs
      *ngIf="form.getRawValue().name"
    >
      <ui-tab>
        <ng-container ngProjectAs="label">{{'components.queryBuilder.fields.title' | translate}}</ng-container>

          <safe-tab-fields
            *ngIf="availableFields.length > 0"
            [form]="$any(form.controls.fields)"
            [fields]="availableFields"
            [showLimit]="true"
          ></safe-tab-fields>
      </ui-tab>
      <ui-tab *ngIf="form.get('sort')" >
        <ng-container ngProjectAs="label">{{
          (showLimit && form.get('first') !== null
            ? 'components.queryBuilder.sort.limitTitle'
            : 'components.queryBuilder.sort.title'
          ) | translate
        }}</ng-container>

        <safe-tab-sort
          [form]="form"
          [fields]="availableScalarFields"
          [showLimit]="showLimit && form.get('first') !== null"
        ></safe-tab-sort>
      </ui-tab>
      <ui-tab
        *ngIf="showFilter && form.get('filter')"
      >
        <ng-container ngProjectAs="label">{{'components.queryBuilder.filter.title' | translate}}</ng-container>

        <safe-tab-filter
          [form]="$any(form.controls.filter)"
          [query]="form.getRawValue()"
        >
        </safe-tab-filter>
      </ui-tab>
      <ui-tab *ngIf="showStyle && form.get('style')">
        <ng-container ngProjectAs="label">{{'components.queryBuilder.style.title' | translate}}</ng-container>

        <safe-tab-style
          [form]="$any(form.controls.style)"
          [scalarFields]="availableScalarFields"
          [query]="form.getRawValue()"
        >
        </safe-tab-style>
      </ui-tab>
      <ui-tab *ngIf="layoutPreviewData">
        <ng-container ngProjectAs="label">{{'common.preview' | translate}}</ng-container>

        <safe-tab-layout-preview [data]="layoutPreviewData">
        </safe-tab-layout-preview>
      </ui-tab>
    </ui-tabs>
  </form>
</ng-container>
