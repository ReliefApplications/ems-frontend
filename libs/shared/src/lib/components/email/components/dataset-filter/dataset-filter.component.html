<form [formGroup]="query">
  <!-- Dataset Select -->
  <div class="mt-3 flex gap-5">
    <div class="w-1/3">
      <label
        class="block text-sm font-medium leading-6 text-gray-900"
        htmlFor="exampleSelect"
      >
        {{ 'components.queryBuilder.block.label' | translate }}
      </label>
      <div
        class="relative flex py-1.5 px-2 focus-within:ring-2 focus-within:ring-inset focus-within:ring-primary-600 shadow-sm rounded-md border-0 ring-1 ring-inset ring-gray-300 items-center w-full"
        [class]="{
          'form-error':
            (query?.controls['name'].value === null ||
              query?.controls['name'].value === '') &&
            query?.controls['name'].touched
        }"
      >
        <input
          id="block_title"
          class="form-input bg-transparent block overflow-hidden border-0 rounded-md w-full p-0 text-gray-900 placeholder:text-gray-400 text-sm sm:leading-6 focus:ring-0 focus:ring-inset ng-valid ng-dirty ng-touched"
          type="text"
          [placeholder]="'components.queryBuilder.block.label' | translate"
          formControlName="name"
          [ngModelOptions]="{ standalone: true }"
          (ngModelChange)="changeBlockTitle()"
        />
      </div>
    </div>
    <!-- select dataset dropdown -->
    <div class="w-1/3">
      <label
        htmlFor="select__dataset"
        class="block text-sm font-medium leading-6 text-gray-900"
      >
        {{ 'components.queryBuilder.dataset.title' | translate }}
      </label>
      <!-- Resource selection -->
      <div uiFormFieldDirective class="flex-1">
        <shared-resource-select
          formControlName="resource"
          [selectedElements]="[query.controls.resource.value]"
          (change)="getResourceData(true)"
        ></shared-resource-select>
        <ui-button
          *ngIf="query.value.resource"
          uiSuffix
          size="small"
          [isIcon]="true"
          (click)="clearFormField('resource', $event)"
          icon="close"
          variant="danger"
          [uiTooltip]="'common.remove' | translate"
        ></ui-button>
      </div>
    </div>
    <!-- For phase 2 -->
    <div class="w-1/3 individual-email-checkbox-container">
      <ui-checkbox
      formControlName="individualEmail"
      [(ngModel)]="separateEmail"
      >
        <ng-container ngProjectAs="label">{{
          'components.select.distribution.separateEmail' | translate
        }}</ng-container>
      </ui-checkbox>
    </div>
    <div class="w-1/3 flex loadingSign">
      <ui-spinner *ngIf="loading" style="position: relative"></ui-spinner>
    </div>
  </div>
  <kendo-tabstrip
    (tabSelect)="onTabSelect($event)"
    #datasetPreview
    *ngIf="resource?.fields?.length && !loadingCheck"
  >
    <!-- Filter Tab -->
    <kendo-tabstrip-tab
      [title]="'Filter'"
      [disabled]="false"
      *ngIf="showPreview === false"
      [selected]="true"
    >
      <ng-template kendoTabTitle>
        {{ 'components.queryBuilder.filter.title' | translate }}
      </ng-template>
      <ng-template kendoTabContent>
        <ng-container
          class="mt-2"
          *ngTemplateOutlet="tooManyRecordsAlertTmpl"
        ></ng-container>
        <ng-container
          class="mt-2"
          *ngTemplateOutlet="invalidFieldsAlertTmpl"
        ></ng-container>
        <ng-container *ngIf="resource?.fields?.length">
          <div class="flex gap-4 mt-2">
            <div class="mt-2">
              <!-- NESTED FILTER GROUP -->
              <shared-filter [form]="query.get('filter')" [fields]="filterFields" [isEmailNotification]="true"></shared-filter>    
            </div>
          </div>

          
          <ui-button
            *ngIf="datasetFilterInfo.controls"
            class="float-right mt-8"
            category="secondary"
            variant="primary"
            (click)="getDataSet('filter')"
          >
            {{ 'components.queryBuilder.filter.apply' | translate }}
          </ui-button>
        </ng-container>
      </ng-template>
    </kendo-tabstrip-tab>
    <!-- Fields Tab -->
    <kendo-tabstrip-tab
      [title]="'Fields'"
      [disabled]="showDatasetLimitWarning"
      *ngIf="showPreview === false"
    >
      <ng-template kendoTabTitle>
        {{ 'components.queryBuilder.fields.title' | translate }}
      </ng-template>
      <ng-template kendoTabContent>
        <ng-container
          class="mt-2"
          *ngTemplateOutlet="tooManyRecordsAlertTmpl"
        ></ng-container>
        <ng-container
          class="mt-2"
          *ngTemplateOutlet="invalidFieldsAlertTmpl"
        ></ng-container>
        <ng-container
          class="mt-2"
          *ngTemplateOutlet="noSelectedFieldsAlertTmpl"
        ></ng-container>
        <div class="flex gap-4 mt-2">
          <div class="mt-2">
            <!-- FIELDS -->
            <shared-tab-fields
              *ngIf="availableFields.length > 0"
              [form]="getFieldsArray()"
              [fields]="availableFields"
              [showLimit]="false"
              [showColumnWidth]="false"
              ></shared-tab-fields>
          </div>
        </div>
        <ng-container>
          <div class="flex gap-5">
            <!-- Available Fields -->
            <div class="mt-4 w-1/2">
              <h3
                htmlFor="exampleSelect"
                class="block text-base font-medium leading-6 text-gray-900 mb-1"
              >
                {{ 'components.queryBuilder.fields.available' | translate }}
              </h3>
              <div class="flex flex-col">
                <label class="mb-1">{{
                  'components.queryBuilder.fields.search' | translate
                }}</label>
                <div uiFormFieldDirective class="!w-full divFields">
                  <input
                    id="searchBar"
                    type="text"
                    [(ngModel)]="searchAvailableField"
                    [ngModelOptions]="{ standalone: true }"
                    placeholder="{{
                      'components.queryBuilder.fields.search' | translate
                    }}"
                  />
                  <ui-button
                    uiSuffix
                    (click)="searchAvailableField = ''"
                    [isIcon]="true"
                    [icon]="searchAvailableField ? 'cancel' : 'search'"
                    [uiTooltip]="
                      'common.' + (searchAvailableField ? 'cancel' : 'search')
                        | translate
                    "
                  ></ui-button>
                </div>
              </div>
              <div class="field-list overflow-auto max-h-[400px]">
                <ng-container
                  *ngFor="
                    let fieldDetails of availableFields;
                    let index = index
                  "
                >
                  <div
                    *ngIf="
                      fieldDetails?.name
                        ?.toLowerCase()
                        ?.includes(searchAvailableField.toLowerCase())
                    "
                    class="field-box cursor-pointer overflow-ellipsis hover:bg-blue-500 hover:text-white"
                    (click)="availableFieldIndex = index"
                    [ngClass]="{
                      'field-select': availableFieldIndex === index
                    }"
                  >
                    {{
                      this.emailService.replaceUnderscores(
                        removeUserString(fieldDetails?.name)
                      ) | titlecase
                    }}
                  </div>
                </ng-container>
              </div>
            </div>
            <!-- Move Left and Right -->
            <div class="flex flex-col items-center justify-center">
              <!-- Add All Available Fields Button -->
              <button
                class="bg-gray-200 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 border border-gray-500 rounded shadow mt-1"
                (click)="addAllAvailableFields()"
              >
                <ui-icon
                  class="text-base"
                  icon="keyboard_double_arrow_right"
                  variant="default"
                ></ui-icon>
              </button>
              <!-- Add Selected Available Field Button -->
              <button
                class="bg-gray-200 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 border border-gray-500 rounded shadow mt-1"
                (click)="addSelectedField()"
              >
                <ui-icon
                  class="text-base"
                  icon="keyboard_arrow_right"
                  variant="default"
                ></ui-icon>
              </button>
              <!-- Move Selected Field Back Button -->
              <button
                class="bg-gray-200 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 border border-gray-500 rounded shadow mt-1"
                (click)="removeSelectiveFields(selectedFieldIndex)"
              >
                <ui-icon
                  class="text-base"
                  icon="keyboard_arrow_left"
                  variant="default"
                ></ui-icon>
              </button>
              <!-- Remove All Selected Fields Button -->
              <button
                class="bg-gray-200 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 border border-gray-500 rounded shadow mt-1"
                (click)="removeAllSelectedFields()"
              >
                <ui-icon
                  class="text-base"
                  icon="keyboard_double_arrow_left"
                  variant="default"
                ></ui-icon>
              </button>
            </div>

            <!-- Selected Fields -->
            <div class="mt-4 w-1/2">
              <h3
                htmlFor="exampleSelect"
                class="block text-base font-medium leading-6 text-gray-900 mb-1"
              >
                {{ 'components.queryBuilder.fields.selected' | translate }}
              </h3>
              <div class="flex flex-col">
                <label class="mb-1">{{
                  'components.queryBuilder.fields.search' | translate
                }}</label>
                <div uiFormFieldDirective class="!w-full divFields">
                  <input
                    id="searchBarSelected"
                    type="text"
                    [(ngModel)]="searchSelectedField"
                    [ngModelOptions]="{ standalone: true }"
                    placeholder="{{
                      'components.queryBuilder.fields.search' | translate
                    }}"
                  />
                  <ui-button
                    uiSuffix
                    (click)="searchSelectedField = ''"
                    [isIcon]="true"
                    [icon]="searchSelectedField ? 'cancel' : 'search'"
                    [uiTooltip]="
                      'common.' + (searchSelectedField ? 'cancel' : 'search')
                        | translate
                    "
                  ></ui-button>
                </div>
              </div>
              <div class="field-list overflow-auto max-h-[400px]">
                <ng-container
                  *ngFor="let fields of selectedFields; let index = index"
                >
                  <div
                    *ngIf="
                      fields?.name
                        ?.toLowerCase()
                        ?.includes(searchSelectedField.toLowerCase())
                    "
                    class="field-box cursor-pointer overflow-ellipsis hover:bg-blue-500 hover:text-white"
                    (click)="selectedFieldIndex = index"
                    [ngClass]="{ 'field-select': selectedFieldIndex === index }"
                  >
                    {{
                      this.emailService.replaceUnderscores(
                        removeUserString(fields.name)
                      ) | titlecase
                    }}
                  </div>
                </ng-container>
              </div>
            </div>
            <!-- Up and Down buttons -->
            <div class="flex flex-col items-center justify-center">
              <!-- Move Selected Field To Top Button -->
              <button
                class="bg-gray-200 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 border border-gray-500 rounded shadow mt-1"
                (click)="moveTop(selectedFieldIndex)"
              >
                <ui-icon
                  class="text-base"
                  icon="keyboard_double_arrow_up"
                  variant="default"
                ></ui-icon>
              </button>
              <!-- Move Selected Field Up Button -->
              <button
                class="bg-gray-200 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 border border-gray-500 rounded shadow mt-1"
                (click)="moveUp(selectedFieldIndex)"
              >
                <ui-icon
                  class="text-base"
                  icon="keyboard_arrow_up"
                  variant="default"
                ></ui-icon>
              </button>
              <!-- Move Selected Field Down Button -->
              <button
                class="bg-gray-200 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 border border-gray-500 rounded shadow mt-1"
                (click)="moveDown(selectedFieldIndex)"
              >
                <ui-icon
                  class="text-base"
                  icon="keyboard_arrow_down"
                  variant="default"
                ></ui-icon>
              </button>
              <!-- Move Selected Field To Bottom Button -->
              <button
                class="bg-gray-200 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 border border-gray-500 rounded shadow mt-1"
                (click)="moveBottom(selectedFieldIndex)"
              >
                <ui-icon
                  class="text-base"
                  icon="keyboard_double_arrow_down"
                  variant="default"
                ></ui-icon>
              </button>
            </div>
          </div>
          <div></div>
        </ng-container>
        <ui-button
          *ngIf="
            tabs?.length > 1 &&
            datasetFilterInfo.controls &&
            activeTab.index !== tabs.length - 1
          "
          class="float-right mt-8"
          category="secondary"
          variant="primary"
          (click)="getDataSet('fields')"
          [disabled]="selectedFields.length === 0 || showDatasetLimitWarning"
        >
          {{ 'components.queryBuilder.filter.apply' | translate }}
        </ui-button>
        <ui-button
          *ngIf="tabs?.length === 1 || activeTab?.index === tabs?.length - 1"
          class="float-right mt-8"
          category="secondary"
          variant="primary"
          (click)="getDataSet('preview'); showPreview = true"
          [disabled]="showDatasetLimitWarning || selectedFields.length === 0"
          [class.disabled-button]="
            showDatasetLimitWarning || selectedFields.length === 0
          "
        >
          {{ 'common.preview' | translate }}
        </ui-button>
      </ng-template>
    </kendo-tabstrip-tab>
    <!-- Style Tab -->
    <!-- <kendo-tabstrip-tab [disabled]="true">
      <ng-template kendoTabTitle >
        <div >
          {{ 'components.queryBuilder.style.title' | translate }}
        </div>
      </ng-template>
      <ng-template kendoTabContent>
      </ng-template>
    </kendo-tabstrip-tab> -->
  </kendo-tabstrip>
  <ng-container
    class="mt-5"
    *ngTemplateOutlet="noFieldsInResourceAlertTmpl"
  ></ng-container>
</form>

<!-- Too many records in dataset -->
<ng-template #tooManyRecordsAlertTmpl>
  <ui-alert
    variant="warning"
    [closable]="true"
    *ngIf="showDatasetLimitWarning"
    (close)="closeWarningMessage()"
  >
    <div
      [innerHTML]="
        'components.email.alert.tooManyRecords'
          | translate : { totalRecords: totalMatchingRecords }
      "
    ></div>
  </ui-alert>
</ng-template>
<!-- No Fields in Resource Message -->
<ng-template #noFieldsInResourceAlertTmpl>
  <ui-alert
    variant="warning"
    [closable]="true"
    *ngIf="
      this.resourcePopulated &&
      this.query?.value?.resource !== null &&
      !this.resource?.fields?.length
    "
  >
    <div
      [innerHTML]="'components.email.alert.noResourceFields' | translate"
    ></div>
  </ui-alert>
</ng-template>
<!-- No selected fields in dataset -->
<ng-template #noSelectedFieldsAlertTmpl>
  <ui-alert
    variant="warning"
    *ngIf="!selectedFields.length && !showDatasetLimitWarning"
    [closable]="true"
  >
    <div>
      {{ 'components.email.alert.noSelectedFields' | translate }}
    </div>
  </ui-alert>
</ng-template>
<!-- Invalid fields in dataset -->
<ng-template #invalidFieldsAlertTmpl>
  <ui-alert
    *ngIf="disabledFields.length > 0"
    variant="danger"
    [closable]="true"
  >
    <div
      [innerHTML]="
        'components.email.alert.invalidFields'
          | translate
            : {
                fields: disabledFields.join(', '),
                types: disabledTypes.join(', ')
              }
      "
    ></div>
  </ui-alert>
</ng-template>
