<ui-dialog size="big" [onClose]="close.bind(this)">
  <ng-container ngProjectAs="header">
    <div class="flex flex-wrap justify-start items-center gap-4 mb-4">
      <ng-container *ngIf="!loading">
        <shared-record-summary
          *ngIf="record"
          [record]="record"
          (showHistory)="onShowHistory()"
        ></shared-record-summary>
        <shared-form-actions
          *ngIf="survey"
          [survey]="survey"
        ></shared-form-actions>
        <!-- <shared-draft-record
          [survey]="survey"
          [formId]="form?.id ?? ''"
          (loadDraft)="onLoadDraftRecord($event)"
        ></shared-draft-record> -->
      </ng-container>
      <ng-template #uploadRecordsContent></ng-template>
    </div>
  </ng-container>
  <ng-container ngProjectAs="content">
    <div class="h-full">
      <div *ngIf="loading; else surveyTmpl" class="h-full flex">
        <ui-spinner class="m-auto block"></ui-spinner>
      </div>
      <ng-template #surveyTmpl>
        <div class="flex h-full">
          <shared-form-pages-layout
            *ngIf="!survey.hidePagesTab"
            class="sticky h-full z-10"
            (showPage)="onShowPage($event)"
            [pages]="survey.visiblePages"
            [selectedPageIndex]="(selectedPageIndex$ | async) ?? 0"
          ></shared-form-pages-layout>

          <!-- Survey Form -->
          <survey [model]="survey" class="flex-1"></survey>
        </div>
      </ng-template>
    </div>
  </ng-container>
  <ng-container ngProjectAs="actions">
    <div class="text-sm text-gray-400 flex absolute left-2 items-center">
      <ng-container *ngIf="autosaving; else latestSave">
        <ui-spinner size="small" class="mr-1" />
        {{ 'common.notifications.autoSaving' | translate }}
      </ng-container>
      <ng-template #latestSave>
        <span *ngIf="latestSaveDate"
          >{{
            'components.form.lastSavedAt'
              | translate : { date: latestSaveDate | sharedDate : 'shortTime' }
          }}
        </span>
      </ng-template>
    </div>

    <ui-button (click)="close()" *ngIf="survey?.showCloseButtonOnModal">
      {{ 'common.close' | translate }}
    </ui-button>
    <ui-button
      (click)="deleteRecord()"
      *ngIf="survey?.showDeleteButtonOnModal"
      category="secondary"
      variant="danger"
    >
      {{ 'common.delete' | translate }}
    </ui-button>
    <ng-container *ngIf="survey?.visiblePages ?? [] as pages">
      <ui-button
        category="secondary"
        variant="primary"
        *ngIf="pages.length > 1 && !survey?.hideNavigationButtons"
        (click)="survey && survey.prevPage()"
        cdkFocusInitial
        [disabled]="!survey || survey.isFirstPage"
      >
        {{ 'common.previous' | translate }}
      </ui-button>
      <ui-button
        category="secondary"
        variant="primary"
        *ngIf="pages.length > 1 && !survey?.hideNavigationButtons"
        (click)="survey && survey.nextPage()"
        cdkFocusInitial
        [disabled]="!survey || survey.isLastPage"
      >
        {{ 'common.next' | translate }}
      </ui-button>
    </ng-container>
    <!-- <ui-button [disabled]="disableSaveAsDraft" (click)="saveAsDraft()">{{
      'components.form.draftRecords.save' | translate
    }}</ui-button> -->
    <ui-button
      category="secondary"
      variant="primary"
      [disabled]="saving || autosaving"
      (click)="submit()"
      cdkFocusInitial
    >
      <p *ngIf="!autosaving">
        {{ 'components.record.modal.update' | translate }}
      </p>
      <ui-spinner *ngIf="autosaving" [size]="'small'" />
    </ui-button>
  </ng-container>
</ui-dialog>

<ng-template #popupTemplate let-data>
  <shared-comments-popup
    [recordId]="record?.id ?? ''"
    [selectedQuestion]="selectedQuestion"
    [comments]="comments"
    [button]="popupAnchor"
    (closeModal)="closePopup()"
  ></shared-comments-popup>
</ng-template>
