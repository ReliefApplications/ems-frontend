import {
  ComponentCollection,
  ICustomQuestionTypeConfiguration,
  SurveyModel,
  SvgRegistry,
  ValueChangedEvent,
} from 'survey-core';
import { Question } from '../types';
import { DomService } from '../../services/dom/dom.service';
import { ComponentRef } from '@angular/core';
import { ShapeFileMapComponent as ShapeFileMapComponent } from '../../components/shapefile-map/shapefile-map.component';

/**
 * Inits the geospatial component.
 *
 * @param domService DOM service.
 * @param componentCollectionInstance ComponentCollection
 */
export const init = (
  domService: DomService,
  componentCollectionInstance: ComponentCollection
): void => {
  // registers icon-shapefile in the SurveyJS library
  SvgRegistry.registerIconFromSvg(
    'shapefile',
    '<svg width="24px" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" class="iconify iconify--gis"><path d="M13.996 0a2.5 2.5 0 0 0-2.5 2.5V70H0v22h11.496v5.5a2.5 2.5 0 0 0 2.5 2.5h72a2.5 2.5 0 0 0 2.5-2.5V21.625c.027-1.113.004-1.777-.732-2.59L69.46.732A2.5 2.5 0 0 0 67.662 0zm2.5 5h48.902l1.252 14.568a2.5 2.5 0 0 0 2.278 2.278l14.568 1.252V95h-67v-3H80V70H16.496zm54.275 4.115 8.61 8.61-7.928-.682zM15.885 74q2.763 0 4.154.957 1.401.957 1.47 2.557l-2.962.103q-.19-.893-.82-1.281-.621-.397-1.872-.397-1.29 0-2.021.418-.47.27-.47.721-.001.413.439.705.56.371 2.722.776 2.163.404 3.194.84 1.041.426 1.62 1.18.59.743.59 1.843.002.997-.699 1.867-.7.87-1.982 1.299-1.28.42-3.191.42-2.784 0-4.276-1.014-1.491-1.02-1.781-2.969l2.883-.22q.26 1.147 1.05 1.685.8.54 2.151.54 1.431 0 2.152-.475.73-.484.73-1.125a.91.91 0 0 0-.308-.698q-.3-.292-1.062-.505-.52-.143-2.371-.506-2.383-.468-3.344-1.149-1.35-.957-1.35-2.336 0-.885.63-1.652.64-.775 1.831-1.18 1.2-.404 2.893-.404m8.527.197h2.813v4.268q1.36-1.26 3.252-1.26.97 0 1.752.285.78.285 1.17.729.4.442.54.98.15.54.15 1.672v4.932h-2.812V81.36q0-1.32-.16-1.677t-.57-.563q-.401-.213-1.012-.213a2.8 2.8 0 0 0-1.25.268 1.7 1.7 0 0 0-.81.816q-.25.539-.25 1.6v4.21h-2.813zm16.692 3.008q1.881 0 2.802.356.922.349 1.293.896.38.538.38 1.986l-.03 2.596q0 1.108.13 1.639a4.3 4.3 0 0 0 .508 1.125h-2.78a7 7 0 0 1-.27-.658 3 3 0 0 0-.1-.26q-.721.554-1.543.83a5.4 5.4 0 0 1-1.75.277q-1.641 0-2.592-.705-.94-.704-.941-1.781 0-.712.432-1.266.428-.562 1.199-.855.78-.3 2.242-.522 1.971-.293 2.732-.547v-.222q0-.64-.4-.908-.4-.278-1.512-.278-.75 0-1.17.237-.42.23-.681.816l-2.553-.365q.431-1.219 1.482-1.805t3.122-.586m13.11 0q1.853 0 3.143 1.149 1.291 1.147 1.291 3.197 0 2.105-1.3 3.277-1.301 1.164-3.153 1.164a4.4 4.4 0 0 1-1.601-.277q-.71-.276-1.5-.95V89H48.28V77.395h2.621v1.236q.511-.633 1.383-1.03a4.6 4.6 0 0 1 1.93-.396m10.73 0q2.37 0 3.742 1.242 1.371 1.236 1.312 3.793h-7.047q.03.99.682 1.543.65.547 1.62.547.66 0 1.11-.285t.682-.918l2.803.371a3.84 3.84 0 0 1-1.711 1.861q-1.161.634-2.912.633-2.774 0-4.106-1.433-1.05-1.148-1.049-2.897 0-2.09 1.381-3.27 1.38-1.187 3.492-1.187zm.17 1.703q-.922 0-1.522.53t-.59 1.44h4.203q-.03-.965-.629-1.464-.601-.507-1.463-.506zm-11.659.055q-1.032 0-1.713.633-.68.625-.68 1.86 0 1.417.711 2.099.71.672 1.73.672.983 0 1.634-.618.65-.626.65-2.043 0-1.32-.672-1.962-.67-.641-1.66-.641m-10.639 2.803q-.541.142-1.712.34-1.17.197-1.53.386-.55.31-.55.785-.001.467.439.807t1.121.34q.762.001 1.453-.395.509-.3.668-.736.11-.286.111-1.086z"/><path d="M49.87 18.951c-2.061.008-2.868.072-4.077.328-6.482 1.374-11.417 4.67-14.963 10.002-2.706 4.07-3.83 8.013-3.83 13.377 0 4.796 1.091 8.482 3.629 12.23 4.179 6.174 9.485 9.271 17.225 10.069 1.828.189 5.452.091 7.056-.2 2.615-.473 5.807-1.758 7.95-3.202 4.11-2.772 7.72-8.067 9.245-13.493 1.218-4.333 1.195-8.968-.08-12.935-2.271-7.069-8.21-12.184-15.927-13.756-1.945-.396-5.547-.54-7.43-.289-.684.09-1.526.2-1.863.242-.425.052-.79.158-1.08.385-.302.236-.465.6-.465.979 0 .294.085.648.386.978.286.314.74.682 1.596 1.38.722.59 1.462 1.249 1.774 1.552l-.11.017c-1.702.266-3.86.814-5.861 1.487-.49.164-.94.312-1.266.412l-.039.011-.004-.023a45 45 0 0 1-.412-4.045l-.07-1.545.377-.178c2.303-1.09 7.06-2.158 9.666-2.17.594-.002 1.006-.027 1.338-.142.16-.056.416-.186.498-.473.085-.299-.081-.55-.213-.681-.152-.153-.339-.193-.469-.22-.15-.03-.325-.05-.549-.064-.446-.028-1.09-.036-2.033-.033zm-1.065 3.83h.35c5.31-.012 10.823 1.947 14.292 4.797l-1.187-.433c-.32-.102-.336-.04-1-.565-.455-.36-.838-.625-1.17-.8a2.2 2.2 0 0 0-.486-.206.9.9 0 0 0-.55.028V25.6a.8.8 0 0 0-.37.265.66.66 0 0 0-.112.557c.02.09.095.145.135.22-1.078-.184-2.242-.325-4.16-.392l-2.297-.08-1.484-1.56zm-9.473 1.287c.012.175.025.322.035.524.02.386.044.76.069 1.054q.018.22.037.38c.01.093.016.173.05.28 0 0 .014.058.03.157.016.104.036.245.056.404a47 47 0 0 1 .227 2.192c.006.075.007.119.01.177l-.237.125c-.296.158-.698.368-1.134.594-1.908.988-3.89 2.196-5.121 3.129-.168.127-.315.235-.461.344a21 21 0 0 1-.13-1.516l-.08-1.387.585-.767c1.65-2.136 3.74-4.224 6.064-5.69m15.486 4.493c.458.004 1.011.021 1.578.048 1.136.055 2.36.15 3.1.252l1.104.15.488.546c1.26 1.4 3 4.227 3.865 6.306.018.042.027.07.043.11-.152-.05-.25-.097-.465-.15a41 41 0 0 0-2.027-.446c-1.511-.297-3.217-.57-4.389-.676l-.756-.068-.865-1.77c-.556-1.137-1.43-2.694-1.986-3.531l-.5-.752c.197-.012.44-.023.81-.02zm-3.85.24.387.486c.893 1.121 1.917 2.764 2.737 4.402q.313.624.459.963c.022.052.031.081.047.123-.011 0-.007.002-.018.002-.938.006-2.438.266-4.082.645s-3.408.88-4.781 1.39l-1.293.48c-.238.086-.318.113-.43.153-.268-.738-1.389-4.643-1.613-5.67l-.17-.783.21-.09c1.824-.781 5.6-1.764 7.733-2.007h.002zm13.175 1.263 1.226.44c1.286.546 1.19.469 1.9 1.383 1.134 1.46 1.915 3.719 2.463 6.228-.069-.056-.125-.114-.207-.172-.326-.23-.77-.484-1.316-.761a3 3 0 0 1-.428-.272 1 1 0 0 1-.127-.119l-.025-.03c-.073-.17-.423-.994-.799-1.884-.793-1.876-1.492-3.122-2.687-4.813m-23.854 1.77c.007.092.017.177.037.291q.04.224.108.55c.089.433.21.988.345 1.577.272 1.178.596 2.492.817 3.268l.232.816-1.121.598c-1.568.836-3.478 2.013-4.777 2.879v-.086l-.79.562c-.162.116-.293.204-.427.295l-.006-.014c-.118-.335-.27-.823-.428-1.39a52 52 0 0 1-.898-3.776c-.076-.393-.137-.677-.154-.85-.019-.179-.012-.2.021-.265.02-.04.126-.16.342-.338a34.7 34.7 0 0 1 5.877-3.746c.327-.164.586-.278.77-.351.022-.01.032-.012.052-.02m-9.75 2.852.04.591-.37.489c.116-.386.221-.785.33-1.08m37.11 2.125.011.029.008.04-.008.097-.043.084-.021.017c-.099-.087-.185-.188-.176-.168zm-12.04.382c.04.097.084.202.139.344a93 93 0 0 1 1.605 4.67l.557 1.809-1.17.06c-3.16.168-6.241.805-8.715 1.813-.269.11-.532.21-.73.28l-.037.013c-.019-.033-.03-.05-.051-.09a14 14 0 0 1-.47-1.012 85 85 0 0 1-1.245-3.219 78 78 0 0 1-.55-1.543c-.06-.17-.101-.303-.137-.418.096-.054.203-.113.37-.19a23 23 0 0 1 1.759-.683c1.404-.49 3.135-.998 4.357-1.242a48 48 0 0 1 4.117-.578zm2.723.006c1.59.03 4.47.506 6.555 1.14.495.152.793.263.935.339.156.083.127.062.184.172.041.08.136.335.232.666.097.33.203.746.303 1.197.201.903.393 1.972.512 2.906.06.476.11.971.142 1.381.028.354.032.608.032.719l-.2-.072c-1.187-.433-3.471-.976-5.334-1.282l-1.187-.195-.508-1.832a63 63 0 0 0-1.18-3.768c-.238-.659-.383-1.075-.486-1.37zm-27.416.969c.006.041.014.069.02.111.133 1.028.928 4.355 1.271 5.315.05.139.094.278.129.398-.308.227-.761.535-1.23.936-.283.242-.552.5-.756.787-.144.202-.173.47-.205.73a29.5 29.5 0 0 1-.584-4.9c-.046-1.27-.046-2.079 0-2.494.012-.119.021-.125.035-.17.034-.006.072.002.105-.008v.002q.153-.047.31-.129a4.7 4.7 0 0 0 .678-.426c.086-.063.148-.098.227-.152m39.072 1.168c.086.526.264.962.319 1.512.18 1.807-.136 3.95-.67 6.209-.088-.091-.1-.229-.203-.305-.14-.104-.174-.153-.182-.168-.009-.017-.022-.054-.018-.217.018-.678-.099-1.913-.275-3.31a59 59 0 0 0-.59-3.692c.424.149.752.243 1.07.227a.8.8 0 0 0 .532-.211c.013-.013.005-.031.017-.045m-27.422 1.603.006.016c.085.224.19.527.293.844a95 95 0 0 0 1.27 3.5c.241.631.462 1.213.62 1.64.057.152.093.255.132.362l-.008.004c-.205.122-.5.285-.822.457-1.462.777-3.695 2.219-4.932 3.187q-.297.232-.523.397c-.078-.115-.156-.226-.254-.385a21 21 0 0 1-.832-1.47c-.468-.928-1.315-2.938-1.664-3.95l-.125-.36 1.035-.742c1.153-.829 2.692-1.8 3.955-2.529a26 26 0 0 1 1.6-.865c.109-.052.167-.071.25-.106zm16.006 5.686v.002c.055.181.125.45.203.76.156.618.335 1.412.473 2.12.072.372.213 1.359.328 2.282.058.462.11.912.149 1.276.027.26.034.389.043.517-.079.007-.083.012-.254.012-.522 0-1.703.136-3.916.586l-.016.002-.01.004-3.322.806-.611-.953a110 110 0 0 1-2.364-3.836c-.306-.525-.556-.97-.724-1.293-.043-.083-.064-.13-.096-.195.069-.032.11-.055.201-.092.371-.152.903-.341 1.494-.535 1.184-.388 2.618-.793 3.53-.969.668-.129 1.953-.284 3.072-.385.559-.05 1.082-.084 1.469-.101a7 7 0 0 1 .351-.008m-28.515.086c0 .008.005.013.006.021l-.002.01zm31.14.1c.24.03.505.065.823.11 1.59.233 3.977.797 4.962 1.163l.395.146.008 1.274c.005.874-.031 2.22-.078 2.945-.04.602-.075.938-.13 1.149-.055.215-.122.336-.306.611a3 3 0 0 1-.26.346c-.058.06-.077.065-.103.072-.027.007-.319-.008-.863-.166l-.006-.002-2.073-.508-.011-.004-.016-.004c-.582-.115-1.104-.216-1.33-.26a6 6 0 0 1-.096-.769c-.123-1.503-.447-3.732-.787-5.414a26 26 0 0 1-.129-.69zm-27.883.027c.78 1.88 1.78 4.017 2.448 5.139.234.392.446.75.6 1.013l.072.123-.016.016c-.16.168-.382.397-.627.646-.266.27-.506.547-.691.791a4 4 0 0 0-.237.346 1 1 0 0 0-.146.395.9.9 0 0 0 .047.42c-1.42-1.6-2.624-3.396-3.422-5.288-.367-.87-.614-1.9-.873-2.912.024.027.039.059.064.084.158.158.323.351.617.403a.8.8 0 0 0 .426-.053c.104-.041.191-.09.285-.145.265-.15.76-.49 1.188-.802.159-.116.187-.126.265-.176m35.98 1.687c-.02.096-.052.194-.073.29l.013-.268zm-23.138 1.27c.14.318.315.674.662 1.28.453.788 1.05 1.78 1.72 2.847.41.657.784 1.27 1.054 1.72.098.165.164.278.23.393-.162.105-.367.23-.607.361-.6.33-1.738 1.071-2.606 1.692l-1.209.867-1.31-1.252c-.73-.697-1.78-1.8-2.639-2.752a38 38 0 0 1-1.082-1.242c-.086-.104-.137-.172-.197-.25.14-.12.322-.27.555-.447.514-.393 1.198-.88 1.847-1.301a28 28 0 0 1 2.572-1.453c.405-.202.765-.367 1.006-.461zm-8.066 5.267c.885 1.13 2.755 3.066 4.207 4.368.511.458.893.826 1.129 1.078.052.056.068.08.103.123a12 12 0 0 1-.318.375c-.1.113-.197.21-.275.283-.044-.014-.08-.025-.135-.045a17 17 0 0 1-.703-.277 28 28 0 0 1-1.645-.748c-1.977-.995-3.812-2.463-5.392-4.174.061.042.124.08.193.096.302.07.608.033 1.164-.008.16-.012.277-.078.344-.112q.135-.069.285-.166c.203-.13.435-.299.662-.484zm24.07.915h.113c.293 0 .744.037 2.01.205.45.06.685.104.94.15-.041.042-.064.071-.11.115-.33.32-.778.709-1.254 1.094-.66.535-1.237.914-1.748 1.244.028-.932.053-1.867.05-2.808zm-2.236.005v4.143c-1 .504-1.95.941-2.93 1.275-.028-.028-.045-.041-.08-.078a17 17 0 0 1-.685-.783 43 43 0 0 1-1.79-2.322c-.312-.437-.544-.754-.685-.967-.021-.032-.026-.044-.041-.07.13-.044.277-.09.537-.172 1.496-.473 3.437-.854 4.932-.969zm-8.658 2.15.185.263.871 1.23.074.106h.004l1.7 2.326c-1.236.224-2.419.395-3.89.386l-.032-.011a2 2 0 0 1-.196-.078 8 8 0 0 1-.593-.332 21 21 0 0 1-1.252-.827l-.873-.646c.59-.443 1.572-1.08 2.494-1.615.499-.29.965-.544 1.303-.71.09-.044.138-.062.205-.091zm-5.68 3.897.057.034-.077-.01zm4.584.418v.25c.023 0-.108-.043-.225-.09l.004-.021.055-.074.05-.035.061-.024.03-.004z"/></svg>'
  );

  const component: ICustomQuestionTypeConfiguration & { category: string } = {
    name: 'shapefile',
    title: 'ShapeFile',
    iconName: 'icon-shapefile',
    inheritBaseProps: true,
    category: 'Custom Questions',
    questionJSON: {
      name: 'shapefile',
      type: 'file',
      acceptedTypes: '.zip',
      allowMultiple: false,
      storeDataAsText: false,
      showPreview: false,
    },
    onAfterRender: (question: Question, el: Element): void => {
      const file = el.querySelector<HTMLElement>('.sd-file');
      if (file) {
        file.style.padding = 'unset';
      }
      (question.survey as SurveyModel).onValueChanged.add(
        (_: SurveyModel, options: ValueChangedEvent) => {
          if (!(options.name === question.name)) {
            return;
          }
          if (options.value) {
            const map: ComponentRef<ShapeFileMapComponent> =
              domService.appendComponentToBody(ShapeFileMapComponent, file);
            const instance = map.instance;
            instance.shapefile = options.value;
          } else {
            const map = el.querySelector<HTMLElement>('shared-shapefile-map');
            map?.remove();
          }
        }
      );
    },
  };
  componentCollectionInstance.add(component);
};
