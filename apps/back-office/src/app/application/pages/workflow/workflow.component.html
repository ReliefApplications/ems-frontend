<!-- Skeleton when loading -->
<ng-container
  *sharedSkeleton="
    loading;
    repeat: 1;
    height: '32px';
    width: '200px';
    shape: 'rectangle'
  "
  class="mb-4"
>
  <div *ngIf="workflow" class="mb-4">
    <div class="flex items-center justify-between gap-4 -mt-4">
      <!-- Title and visibility icon -->
      <div class="flex items-center gap-1 overflow-x-auto">
        <!-- Editable Title -->
        <shared-editable-text
          [text]="workflow.name"
          [uiTooltip]="workflow.name ?? ''"
          [canEdit]="canEditName"
          (onChange)="saveName($event)"
          (formActiveEvent)="formActive = $event"
          class="whitespace-nowrap max-w-[200px] overflow-hidden font-bold"
        >
          <h1 class="!m-0 overflow-hidden text-ellipsis">
            {{ workflow.name }}
          </h1>
        </shared-editable-text>
        <!-- Visibility button icon -->
        <ui-button
          [isIcon]="true"
          variant="grey"
          category="primary"
          [icon]="workflow.page?.visible ? 'visibility' : 'visibility_off'"
          (click)="togglePageVisibility()"
          [uiTooltip]="
            (workflow.page?.visible
              ? 'components.application.pages.hide'
              : 'components.application.pages.show'
            ) | translate
          "
        >
        </ui-button>
        <!-- Steps container: for bigger screens, default view -->
        <ng-container *ngIf="largeDevice">
          <ng-container *ngTemplateOutlet="stepsTmpl"></ng-container>
        </ng-container>
      </div>
      <!-- Action buttons at right end -->
      <div class="flex items-center gap-1" *ngIf="!formActive">
        <!-- Page permissions button icon -->
        <shared-access
          [access]="workflow.permissions"
          [application]="workflow.page?.application?.id"
          [objectTypeName]="'common.page.one' | translate"
          (save)="saveAccess($event)"
          *ngIf="workflow.page?.canUpdate || false"
        ></shared-access>
        <!-- Options button icon -->
        <ui-button
          variant="grey"
          [isIcon]="true"
          icon="more_vert"
          [uiMenuTriggerFor]="menu"
          cdkOverlayOrigin
          #appMenuTrigger="cdkOverlayOrigin"
          [uiTooltip]="'common.options' | translate"
        >
        </ui-button>
        <ui-menu #menu>
          <button uiMenuItem (click)="onAppSelection()">
            <ui-icon icon="file_copy" variant="grey"></ui-icon>
            {{ 'common.duplicate' | translate }}
          </button>
        </ui-menu>

        <!-- "Duplicate to" menu title -->
        <ng-template #searchMenuHeaderTemplate>
          <ui-alert>
            {{ 'models.page.tooltip.duplicate' | translate }}
          </ui-alert>
        </ng-template>
        <!-- "Duplicate to" menu -->
        <ng-template
          cdkConnectedOverlay
          [cdkConnectedOverlayOrigin]="appMenuTrigger"
          [cdkConnectedOverlayOpen]="showAppMenu"
        >
          <shared-search-menu
            [headerTemplate]="searchMenuHeaderTemplate"
            [currentApplicationId]="applicationId"
            [applications]="applications"
            (close)="showAppMenu = false"
            (open)="onDuplicate($event)"
          ></shared-search-menu>
        </ng-template>
      </div>
    </div>
    <!-- Steps container: displayed on smaller screens -->
    <ng-container *ngIf="!largeDevice">
      <ng-container *ngTemplateOutlet="stepsTmpl"></ng-container>
    </ng-container>
    <ui-divider></ui-divider>
  </div>
</ng-container>

<!-- STEPS -->
<ng-template #stepsTmpl>
  <shared-workflow-stepper
    class="overflow-x-auto"
    [loading]="loading"
    [steps]="steps"
    [canUpdate]="canUpdate"
    (add)="onAddStep()"
    (openStep)="onOpenStep($event)"
    (delete)="onDeleteStep($event)"
    (reorderSteps)="onReorderSteps($event)"
    [activeStep]="activeStep"
  >
  </shared-workflow-stepper>
</ng-template>

<router-outlet (activate)="onActivate($event)"></router-outlet>
